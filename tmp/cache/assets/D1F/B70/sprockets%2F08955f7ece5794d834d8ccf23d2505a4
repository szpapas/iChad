o: ActiveSupport::Cache::Entry	:@expires_in0:@value{	"lengthiùî"_version"%14422df8b73f5719d81a9048fdf5a941"digest"%7df4e0e56fb9e9c1778e908521e5ce68"source"ùî/* æœ¨ è¦ åœ°æ‘

This file is part of Ext JS 4

Copyright (c) 2011 Sencha Inc

Contact:  http://www.sencha.com/contact

GNU General Public License Usage
This file may be used under the terms of the GNU General Public License version 3.0 as published by the Free Software Foundation and appearing in the file LICENSE included in the packaging of this file.  Please review the following information to ensure the GNU General Public License version 3.0 requirements will be met: http://www.gnu.org/copyleft/gpl.html.

If you are unsure which license is appropriate for your use, please contact the sales department at http://www.sencha.com/contact.

*/
/*!
 * Ext JS Library 4.0
 * Copyright(c) 2006-2011 Sencha Inc.
 * licensing@sencha.com
 * http://www.sencha.com/license
 */



Ext.define('MyDesktop.ArchiveMan', {
  extend: 'Ext.ux.desktop.Module',

  requires: [
    '*',
    'Ext.tree.*',
    'Ext.data.*',
    'Ext.window.MessageBox'
  ],

  id:'archiveman',
  init : function(){
    this.launcher = {
      text: 'æ¡£æ¡ˆç®¡ç†',
      iconCls:'archiveman',
      handler : this.createWindow,
      scope: this
    }
  },
  
  createWindow : function(){
    var dh='';
    var imagefx=1; //1ä»£è¡¨çºµå‘ï¼Œï¼’ä»£è¡¨æ¨ªå‘
    var desktop = this.app.getDesktop();
	Ext.QuickTips.init();
	var scale1 = 1;
	var scaleMultiplier1 = 0.8;
	var translatePos1 =  { x: 0,y: 0};
	var imageObj1 = new Image();
	

  	var scale1 = 1;
  	var scaleMultiplier1 = 0.8;
  	var translatePos1 =  { x: 0,y: 0};
  	var imageObj1 = new Image();
  

    var canvas_string =
      '<div id="wrapper1" oncontextmenu="return false">'
      +' <canvas id="myCanvas1" width="900" height="1200">'
      +' </canvas>'
      +'</div>';
    var win = desktop.getWindow('archiveman');
  var drawarchive = function(scale, translatePos, imageObj){

   var canvas = document.getElementById("myCanvas1");
   var context = canvas.getContext("2d");
     scale=1
   // clear canvas
  
   context.clearRect(0, 0, canvas.width, canvas.height);
   context.save();

   //context.translate(translatePos.x, translatePos.y);
   //context.scale(scale, scale);

   imageObj.onload = function(){
     //imgW = imageObj.width;
    imgW =Ext.getCmp('imagelist').width;
    
    imgH=imgW*(imageObj.height/imageObj.width);
     //imgH = imageObj.height;
     context.drawImage(imageObj, translatePos.x , translatePos.y , imgW * scale, imgH * scale );
   };

   //imgW = imageObj.width;
   //imgH = imageObj.height;
    imgW =Ext.getCmp('imagelist').width;
    
    imgH=imgW*(imageObj.height/imageObj.width);
   context.drawImage(imageObj, translatePos.x , translatePos.y , imgW * scale, imgH * scale );

   context.restore();
  }

  var set_imagearchive = function(photoURL) {
   var canvas = document.getElementById("myCanvas1");
   var context = canvas.getContext("2d");
   var startDragOffset = {};
   var mouseDown = false;

   //scale = 1.0;
   translatePos1 =  { x: 0,y: 0};
   imageObj1.src = photoURL;


   // add event listeners to handle screen drag
   canvas.addEventListener("mousedown", function(evt){
     mouseDown = true;
     startDragOffset.x = evt.clientX - translatePos1.x;
     startDragOffset.y = evt.clientY - translatePos1.y;
   });

   canvas.addEventListener("mouseup", function(evt){
     mouseDown = false;
   });

   canvas.addEventListener("mouseover", function(evt){
     mouseDown = false;
   });

   canvas.addEventListener("mouseout", function(evt){
     mouseDown = false;
   });

   canvas.addEventListener("mousemove", function(evt){
     if (mouseDown) {
       translatePos1.x = evt.clientX - startDragOffset.x;
       translatePos1.y = evt.clientY - startDragOffset.y;
       drawarchive(scale, translatePos1, imageObj1);
     }
   });
   // add event listeners to handle screen drag
   

   drawarchive(scale, translatePos1,imageObj1);
  };

    var myuploadform= new Ext.FormPanel({
      id : 'my_upload_form',
      fileUpload: true,
      width: 300,
      height : 100,
      autoHeight: true,
      bodyStyle: 'padding: 5px 5px 5px 5px;',
      labelWidth: 0,
      defaults: {
        anchor: '95%',
        allowBlank: false,
        msgTarget: 'side'
      },
      layout : 'absolute',
      items:[{
        xtype: 'label',
        text: 'å¢åŠ å½±åƒæˆ–é™„ä»¶æ–‡ä»¶ï¼š(æ”¯æŒjpgã€tifã€zipã€rarã€docã€cebã€pdfæ ¼å¼)ï¼Œæ–‡ä»¶åä¸èƒ½åŒ…å«ç©ºæ ¼å’Œå•å¼•å·ã€‚',
        x: 10,
        y: 10,
        width: 100
      },
      {
        xtype: 'fileuploadfield',
        id: 'filedata',
        x: 10,
        y: 45,
        emptyText: 'é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶...',
        buttonText: 'æµè§ˆ'
      }],
      buttons: [
      {
        text: 'ä¸Šä¼ ',
        handler: function(){
          if (dh==''){
            msg('æç¤º', 'è¯·å…ˆé€‰æ‹©è¦å¢åŠ å½±åƒæ–‡ä»¶çš„æ¡ˆå·.');
          } 
          else
          {
            myForm = Ext.getCmp('my_upload_form').getForm();
            filename=myForm._fields.items[0].lastValue.split('\\');
            file=filename[filename.length-1];
            new Ajax.Request("/desktop/get_image_sfcf", { 
                method: "POST",
                parameters: eval("({filename:'" + file + "',dh:'" + dh +"',userid:" + currentUser.id + "})"),
                onComplete:  function(request) {
                  if (request.responseText=='notsort'){
                    alert("æ‚¨æ— æ­¤ç±»æ¡£æ¡ˆå½±åƒæ–‡ä»¶ä¸Šä¼ çš„æƒé™ã€‚");
                  }else{
                    sfsc=false;
                    if (request.responseText=='true'){
                      Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ­¤å·ä¸­æ–‡ä»¶åä¸ºï¼š"+file+"çš„å·²ç»å­˜åœ¨ï¼Œæ˜¯å¦æ’å…¥ï¼Ÿ",function callback(id){
                                  if(id=="yes"){
                          if(myForm.isValid())
                                {
                                    form_action=1;
                                    myForm.submit({
                                      url: '/desktop/upload_file',
                                      waitMsg: 'æ–‡ä»¶ä¸Šä¼ ä¸­...',
                                      success: function(form, action){
                                        var isSuc = action.result.success; 

                                        if (isSuc) {
                                          new Ajax.Request("/desktop/save_image_db", { 
                                            method: "POST",
                                            parameters: eval("({filename:'" + file + "',dh:'" + dh +"',czr:'" + currentUser.id +"',czrname:'" + currentUser.username +"'})"),
                                            onComplete:  function(request) {
                                              if (request.responseText=='true'){
                                                timage_store.load();
                                                Ext.getCmp('timage_combo').lastQuery = null;
                                                msg('æˆåŠŸ', 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ.');                       
                                              }else{
                                                alert("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ã€‚" + request.responseText);
                                              }
                                            }
                                          }); //save_image_db
                                        } else { 
                                          msg('å¤±è´¥', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥.');
                                        }
                                      }, 
                                      failure: function(){
                                        msg('å¤±è´¥', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥.');
                                      }
                                    });
                                }
                        }
                      })
                    }
                    else {
            
                      if(myForm.isValid())
                            {
                                form_action=1;
                                myForm.submit({
                                  url: '/desktop/upload_file',
                                  waitMsg: 'æ–‡ä»¶ä¸Šä¼ ä¸­...',
                                  success: function(form, action){
                                    var isSuc = action.result.success; 
                        
                                    if (isSuc) {
                                      new Ajax.Request("/desktop/save_image_db", { 
                                        method: "POST",
                            parameters: eval("({filename:'" + file + "',dh:'" + dh +"',czr:'" + currentUser.id +"',czrname:'" + currentUser.username +"'})"),
                                        //parameters: eval("({filename:'" + file + "',dh:'" + dh +"'})"),
                                        onComplete:  function(request) {
                                          if (request.responseText=='true'){
                                            timage_store.load();
                                            Ext.getCmp('timage_combo').lastQuery = null;
                                            msg('æˆåŠŸ', 'æ–‡ä»¶ä¸Šä¼ æˆåŠŸ.');                       
                                          }else{
                                            alert("æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ã€‚" + request.responseText);
                                          }
                                        }
                                      }); //save_image_db
                                    } else { 
                                      msg('å¤±è´¥', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥.');
                                    }
                                  }, 
                                  failure: function(){
                                    msg('å¤±è´¥', 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥.');
                                  }
                                });
                            }
                    }
                  }         
                    
                  }
              });

          } //else
        } //handler
      }] //buttonsj
    });
    var tabPanel = new Ext.TabPanel({
      activeTab : 0,//é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªtabé¡µ
      animScroll : true,//ä½¿ç”¨åŠ¨ç”»æ»šåŠ¨æ•ˆæœ
      enableTabScroll : true,//tabæ ‡ç­¾è¶…å®½æ—¶è‡ªåŠ¨å‡ºç°æ»šåŠ¨æŒ‰é’®
      items: [
        {
          title: 'æ¬¢è¿é¡µé¢',
          height:600,
          closable : false,//å…è®¸å…³é—­
          html : '<div style="height:600px;padding-top:200px;text-align: center;"><font size = 6>æ¬¢è¿ä½¿ç”¨æ¡£æ¡ˆç®¡ç†ä¿¡æ¯ç³»ç»Ÿ</font></div>'
        }
      ],listeners:{
        "contextmenu":function(tabPanel,myitem,e){
          var menu = new Ext.menu.Menu([
            {text:"å…³é—­å½“å‰é€‰é¡¹é¡µ",handler:function(){
              if(myitem != tabPanel.getItem(0)) {
                tabPanel.remove(myitem);
              }
            }},
            {text:"å…³é—­å…¶ä»–æ‰€æœ‰é€‰é¡¹é¡µ",handler:function() {
                tabPanel.items.each(function(item){
                  if(item != myitem && item != tabPanel.getItem(0)) {
                    tabPanel.remove(item);
                  }
                });
              }
            }
          ]);
          menu.showAt(e.getPoint());
        }
      } 
    });

    // Go ahead and create the TreePanel now so that we can use it below
    var AjListFn_zh = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }else{
                      //alert('O,no');
                    }
                  
                });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
              var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,
           // '->',
           // '<span style=" font-size:12px;font-weight:600;color:#3366FF;">é¢˜åæŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',id:'query_jr_text'
           // },          
           // {xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢å·å†…ç›®å½•',iconCls:'accordion',
           //     handler: function() {
           //       store3.proxy.url="/desktop/get_document_where";
           //       store3.proxy.extraParams.query=Ext.getCmp('query_jr_text').value;
           //       store3.load();
           //     }
           // }
         {
            xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
              handler: function() {
                  var grid = Ext.getCmp('archive_grid');                    
                  var records = grid.getSelectionModel().getSelection();
                  size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                  if (size==1){         
                    size=Ext.getCmp('document_grid').store.count();
                      if (size>0){                                    
                        alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                      }else{
                        var record = records[0];
                        DispJr_model(record.data.id,record.data.dh,false);
                      }
                  }else{
                    alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                  }
              }
         }, 

       	 {
            xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'jr_advance-search',iconCls:'search',

            handler: function() {
              showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
            }
         }
       
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
    ã€€ã€€{ text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
  ã€€ã€€ã€€ã€€ã€€ã€€{ text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true,flex: 1, dataIndex: 'tm',
		  	renderer: function(value,metaData,record,colIndex,store,view) {
						metaData.tdAttr = 'data-qtip="' + value + '"';
			            return value;		
			}
		  },
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      


      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        //multiSelect:false,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],

        tbar:[
		  
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_zh(record,true,title);
            }
          } ,
            {
              xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });
              }
            },
            {
              xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_zh(record,false,title);
              }
            }, 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // } ,         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.proxy.extraParams.dh=title;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'æ¡ˆå·å·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'æ ‡é¢˜åç§°',  width : 175, sortable : true, dataIndex: 'tm',
		  	renderer: function(value,metaData,record,colIndex,store,view) {
						metaData.tdAttr = 'data-qtip="' + value + '"';
			            return value;		
			}
		  },
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'ä»¶æ•°',  width : 75, sortable : true, dataIndex: 'js'},
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          { text : 'èµ·æ—¥æœŸ',  width : 0, sortable : true, dataIndex: 'qrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          //{ text : 'æ­¢æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'zrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'èµ·å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qny'},
          { text : 'æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'zny'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
        ],
        selType:'checkboxmodel',
        //multiSelect:true,
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
              switch (r.data.dalb) { 
                case "0": 
                  DispAj_zh(r,false,title);
                  break; 
                case "2": 
                  DispAj_cw(r,false,title);
                  break; 
                case "3": 
                  DispAj_tddj(r,false,title);
                  break; 
                default:
                  DispAj_zh(r,false,title);
                  break;
              }
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
      });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
		new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
        //set_imagearchive("/assets/dady/fm.jpg");
    set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };

    var AjListFn_zp = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'sxh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'psrq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'zph',    type: 'string'},
            {name: 'psz',    type: 'string'},
            {name: 'sy',    type: 'string'},
            {name: 'dd',    type: 'string'},
            {name: 'rw',    type: 'string'},
            {name: 'bj',    type: 'string'},
            {name: 'ownerid',   type: 'integer'},
            {name: 'zpid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr_zp(record,true);
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }else{
                      //alert('O,no');
                    }
                  
                });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
              var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr_zp(model,false);
              });
            }
          } ,
         {
            xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
              handler: function() {
                  var grid = Ext.getCmp('archive_grid');                    
                  var records = grid.getSelectionModel().getSelection();
                  size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                  if (size==1){         
                    size=Ext.getCmp('document_grid').store.count();
                      if (size>0){                                    
                        alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                      }else{
                        var record = records[0];
                        DispJr_model(record.data.id,record.data.dh,false);
                      }
                  }else{
                    alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                  }
                }
         }    , 
           {
                xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                handler: function() {
                  showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                }
             }
          
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç…§ç‰‡å·',  width : 30, sortable : true, dataIndex: 'zph'},
          
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'æ‹æ‘„è€…',  width : 105, sortable : true, dataIndex: 'psz'},

          { text : 'äº‹ç”±',  width : 105, sortable : true, dataIndex: 'sy'},
          { text : 'åœ°ç‚¹',  width : 75, sortable : true, dataIndex: 'dd'},
        ã€€ã€€{ text : 'äººç‰©',  width : 105, sortable : true, dataIndex: 'rw'},
          { text : 'èƒŒæ™¯',  width : 75, sortable : true, dataIndex: 'bj'},


          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'psrq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'},
      { text : 'zpid',  flex : 1, sortable : true, dataIndex: 'zpid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr_zp(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      


      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        //multiSelect:false,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],

        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_zp(record,true,title);
            }
          } ,
            {
              xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });
                
              }
            },
            {
              xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_zp(record,false,title);
              }
            }, 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // } ,         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.proxy.extraParams.dh=title;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'æ¡ˆå·å·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'æ ‡é¢˜åç§°',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'ä»¶æ•°',  width : 75, sortable : true, dataIndex: 'js'},
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          { text : 'èµ·æ—¥æœŸ',  width : 0, sortable : true, dataIndex: 'qrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'æ­¢æ—¥æœŸ',  width : 0, sortable : true, dataIndex: 'zrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'èµ·å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qny'},
          { text : 'æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'zny'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
        ],
        selType:'checkboxmodel',
        //multiSelect:true,
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
              switch (r.data.dalb) { 
                case "0": 
                  DispAj_zh(r,false,title);
                  break; 
                case "2": 
                  DispAj_cw(r,false,title);
                  break; 
                case "3": 
                  DispAj_tddj(r,false,title);
                  break; 
                default:
                  DispAj_zp(r,false,title);
                  break;
              }
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
        set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };

    
    var AjListFn_cw = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[{
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid_cw');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {
              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
            }
          },
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
              var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          },
          {
            xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
              handler: function() {
                  var grid = Ext.getCmp('archive_grid_cw');                 
                  var records = grid.getSelectionModel().getSelection();
                  size=Ext.getCmp('archive_grid_cw').getSelectionModel().getSelection().size();
                  if (size==1){         
                    size=Ext.getCmp('document_grid').store.count();
                      if (size>0){                                    
                        alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                      }else{
                        var record = records[0];
                        DispJr_model(record.data.id,record.data.dh,false);
                      }
                  }else{
                    alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                  }
                }
         }    , 
           {
                xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                handler: function() {
                  showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                }
             }

        //  },'->',
        //  {
        //    xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
        //    handler: function() {
        //      showAdvancedSearch();
        //    }
        //  },
        //    '<span style=" font-size:12px;font-weight:600;color:#3366FF;">é¢˜åæŸ¥è¯¢</span>:&nbsp;&nbsp;',
        //  {
        //    xtype:'textfield',id:'query_jr_text'
        //  },          
        //  {
        //    xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢å·å†…ç›®å½•',iconCls:'accordion',
        //    handler: function() {
        //      store3.proxy.url="/desktop/get_document_where";
        //      store3.proxy.extraParams.query=Ext.getCmp('query_jr_text').value;
        //      store3.load();
        //    }
        //  }

        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'dalb',    type: 'string'},
          {name: 'jnzs',    type: 'string'},
          {name: 'fjzs',    type: 'string'},
          {name: 'pzqh',    type: 'string'},
          {name: 'pzzh',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
          id:'archive_store',
          model : 'archive_model',
          proxy: {
            type: 'ajax',
            url : '/desktop/get_archive_qxdm',
            extraParams: {query:title},
            reader: {
              type: 'json',
              root: 'rows',
              totalProperty: 'results'
            }
          }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid_cw',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
                  {
                    xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
                    handler: function() {

                      var grid = Ext.getCmp('archive_grid_cw');
                      var records = grid.getSelectionModel().getSelection();
                      var record = records[0];
                      DispAj_cw(record,true,title);
                    }
                  } ,
                    {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
                      handler: function() {

                        var grid = Ext.getCmp('archive_grid_cw');
                        var records = grid.getSelectionModel().getSelection();
                        var record = records[0];
                        var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                        Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                              if(id=="yes"){
                                new Ajax.Request("/desktop/delete_archive", { 
                                  method: "POST",
                                  parameters: eval(pars),
                                  onComplete:  function(request) {
                                    if (request.responseText=='success'){
                                        Ext.getCmp('archive_grid_cw').store.load();
                                    }else{
                                        alert(request.responseText);
                                    }
                                  }
                                });
                              }
                          });
                        

                      }
                    },
                    {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
                      handler: function() {
                        var grid = Ext.getCmp('archive_grid_cw');
                        var records = grid.getSelectionModel().getSelection();
                        var record = records[0];
                        DispAj_cw(record,false,title);
                      }
                    }   , 
                    {
                        xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                        handler: function() {
                          showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid_cw",title);
                        }
                      }, 
                    {
                      text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
                      iconCls:'',
                      handler : function() {
                        var items = Ext.getCmp('archive_grid_cw').getSelectionModel().selected.items;
                        if (items.length > 0) {
                          var item = items[0];
                          var dh = items[0].data.dh;
                          show_image(dh);               
                          set_image("/assets/dady/fm.jpg");
                        }
                      }    
                    },
                    {
                  text:'å¤‡è€ƒè¡¨',
                  iconCls:'yl',
                  handler : function() {
                    var items = Ext.getCmp('archive_grid_cw').getSelectionModel().selected.items;
                    if (items.length > 0) {
                      var item = items[0];
                      var id = items[0].data.id;
                      DispBkb(id);
                    }
                  }    
                },
                        '->',
                      //  {
                      //    xtype: 'combo',
                      //    name: 'aj_select',
                      //    store: aj_where_field_data,
                      //    emptyText:'æ¡ˆå·æ ‡é¢˜',
                      //    mode: 'local',
                      //    minChars : 2,
                      //    valueField:'text',
                      //    displayField:'text',
                      //    triggerAction:'all',
                      //    id:'aj_select_field'
                      //  } ,
                      //  '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
                      //  {
                      //    xtype:'textfield',
                      //    id:'query_text',
                      //  } ,         
                      //  { xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
                      //    handler: function() {
                      //      console.log(Ext.getCmp('query_text').value);
                      //      if(Ext.getCmp('query_text').value != null ){
                      //        var grid = Ext.getCmp('archive_grid_cw');
                      //        grid.store.proxy.url="/desktop/get_archive_where";
                      //        archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
                      //        archive_store.load();
                      //      }
                      //    }
                      //  }
                ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'æ¡ˆå·å·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'æ ‡é¢˜åç§°',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'ä»¶æ•°',  width : 75, sortable : true, dataIndex: 'js'},
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          
          { text : 'å·å†…å¼ æ•°',   width : 50, sortable : true, dataIndex: 'jnzs'},
          { text : 'é™„ä»¶å¼ æ•°',   width : 50, sortable : true, dataIndex: 'fjzs'},
          { text : 'å‡­è¯èµ·å·',  width : 50, sortable : true, dataIndex: 'pzqh'},
          { text : 'å‡­è¯æ­¢å·',  width : 50, sortable : true, dataIndex: 'pzzh'},
          
          { text : 'èµ·æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'qrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'æ­¢æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'zrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'èµ·å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qny'},
          { text : 'æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'zny'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'åœ°ç±å·',  width : 75, sortable : true, dataIndex: 'djh'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                switch (r.data.dalb) { 
                  case "0": 
                    DispAj_zh(r,false,title);
                    break; 
                  case "2": 
                    DispAj_cw(r,false,title);
                    break; 
                  case "3": 
                    DispAj_tddj(r,false,title);
                    break; 
                  default:
                    DispAj_zh(r,false,title);
                    break;
                }
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
      });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
        set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };

    
    var AjListFn_tddj = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                       parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
              var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          },{
            xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
              handler: function() {
                  var grid = Ext.getCmp('archive_grid_tddj');                   
                  var records = grid.getSelectionModel().getSelection();
                  size=Ext.getCmp('archive_grid_tddj').getSelectionModel().getSelection().size();
                  if (size==1){         
                    size=Ext.getCmp('document_grid').store.count();
                      if (size>0){                                    
                        alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                      }else{
                        var record = records[0];
                        DispJr_model(record.data.id,record.data.dh,false);
                      }
                  }else{
                    alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                  }
                }
			},{
		            xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'jr_advance-search',iconCls:'search',
		            handler: function() {
		              showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
		            }
		    }

        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      	  { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      	  { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });

      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'djh',   type: 'string'},
          {name: 'qlrmc',   type: 'string'},
          {name: 'tdzl',    type: 'string'},
          {name: 'qsxz',    type: 'string'},
          {name: 'ydjh',    type: 'string'},
          {name: 'tdzh',    type: 'string'},
          {name: 'tfh',   type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid_tddj',
        store: archive_store,
            bbar:[
              new Ext.PagingToolbar({
                store: archive_store,
                pageSize: 25,
                width : 400,
                border : false,
                displayInfo: true,
                displayMsg: '{0} - {1} of {2}',
                emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
                prependButtons: true
              })
            ],
        tbar:[
		  
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_tddj(record,true,title);
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_archive", { 
                        method: "POST",
                        parameters: eval(pars),
                        onComplete:  function(request) {
                            if (request.responseText=='success'){
                            Ext.getCmp('archive_grid_tddj').store.load();
                            }else{
                                alert(request.responseText);
                            }
                        }
                      });
                    }
                });
              
            }
          },
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
            handler: function() {
              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_tddj(record,false,title);
            }
          },{
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,åœ°ç±å·;djh,åœŸåœ°åè½;tdzl,æƒåˆ©äººåç§°;qlrmc,åœŸåœ°è¯å·;tdzh,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid_tddj",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid_tddj').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid_tddj').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
         // {
         //   xtype: 'combo',
         //   name: 'aj_select',
         //   store: aj_where_field_data,
         //   emptyText:'æ¡ˆå·æ ‡é¢˜',
         //   mode: 'local',
         //   minChars : 2,
         //   valueField:'text',
         //   displayField:'text',
         //   triggerAction:'all',
         //   id:'aj_select_field'
         // } ,
         //   '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
         // {
         //   xtype:'textfield',
         //   id:'query_text'                        } ,         
         // { 
         //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
         //   handler: function() {
         //     console.log(Ext.getCmp('query_text').value);
         //     if(Ext.getCmp('query_text').value != null ){
         //       var grid = Ext.getCmp('archive_grid_tddj');
         //       grid.store.proxy.url="/desktop/get_archive_where";
         //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
         //       archive_store.load();
         //     }
         //   }
        //  }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'æ¡ˆå·å·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'åœ°ç±å·',  width : 175, sortable : true, dataIndex: 'djh'},
          
          { text : 'æƒåˆ©äººåç§°',  width : 175, sortable : true, dataIndex: 'qlrmc'},
          { text : 'åœŸåœ°åè½',  width : 175, sortable : true, dataIndex: 'tdzl'},
          { text : 'æƒå±æ€§è´¨',  width : 175, sortable : true, dataIndex: 'qsxz'},
          { text : 'åœŸåœ°è¯å·',  width : 175, sortable : true, dataIndex: 'tdzh'},
          { text : 'å›¾å¹…å·',  width : 75, sortable : true, dataIndex: 'tfh'},
          
          { text : 'ä»¶æ•°',  width : 75, sortable : true, dataIndex: 'js'},
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          //{ text : 'èµ·æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'qrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          //{ text : 'æ­¢æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'zrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'èµ·å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qny'},
          { text : 'æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'zny'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_tddj(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
      });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
        set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab); 
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };

    var AjListFn_kyq = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
              var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } , 
        {
            xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
              handler: function() {
                  var grid = Ext.getCmp('archive_grid_tddj');                   
                  var records = grid.getSelectionModel().getSelection();
                  size=Ext.getCmp('archive_grid_tddj').getSelectionModel().getSelection().size();
                  if (size==1){         
                    size=Ext.getCmp('document_grid').store.count();
                      if (size>0){                                    
                        alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                      }else{
                        var record = records[0];
                        DispJr_model(record.data.id,record.data.dh,false);
                      }
                  }else{
                    alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                  }
                }
         }    , 
           {
                xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                handler: function() {
                  showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                }
             }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });

      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'djh',   type: 'string'},
          {name: 'qlrmc',   type: 'string'},
          {name: 'tdzl',    type: 'string'},
          {name: 'qsxz',    type: 'string'},
          {name: 'ydjh',    type: 'string'},
          {name: 'tdzh',    type: 'string'},
          {name: 'tfh',   type: 'string'},
          {name: 'dalb',    type: 'string'},
          {name: 'ksmc',    type: 'string'},
          {name: 'kyqr',    type: 'string'},
          {name: 'kswz',   type: 'string'},

          {name: 'xxkz',    type: 'string'},
          {name: 'yxkz',    type: 'string'},
          {name: 'ksbh',   type: 'string'},
          {name: 'ksgm',    type: 'string'},
          {name: 'xzqdm',    type: 'string'},
          {name: 'kz',    type: 'string'},
          {name: 'djlx',   type: 'string'},

          {name: 'kqfw',    type: 'string'},
          {name: 'ksmj',    type: 'string'},
          {name: 'cl',   type: 'string'},
          {name: 'sjncl',    type: 'string'},
          {name: 'clgm',    type: 'string'},
          {name: 'yxqq',    type: 'string'},
          {name: 'yxqz',   type: 'string'},

        {name: 'yxqx',    type: 'string'},
          {name: 'fzjg',    type: 'string'},
          {name: 'mjdw',   type: 'string'},
          {name: 'cldw',    type: 'string'},
          {name: 'scgm',    type: 'string'},
          {name: 'scldw',    type: 'string'},
          {name: 'jjlx',   type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid_tddj',
        store: archive_store,
            bbar:[
              new Ext.PagingToolbar({
                store: archive_store,
                pageSize: 25,
                width : 400,
                border : false,
                displayInfo: true,
                displayMsg: '{0} - {1} of {2}',
                emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
                prependButtons: true
              })
            ],
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_kyq(record,true,title);
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_archive", { 
                        method: "POST",
                        parameters: eval(pars),
                        onComplete:  function(request) {
                            if (request.responseText=='success'){
                            Ext.getCmp('archive_grid_tddj').store.load();
                            }else{
                                alert(request.responseText);
                            }
                        }
                      });
                    }
                });
              
            }
          },
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
            handler: function() {
              var grid = Ext.getCmp('archive_grid_tddj');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_kyq(record,false,title);
            }
          },{
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,çŸ¿ä¸šæƒäºº;kyqr,çŸ¿å±±åç§°;ksmc,çŸ¿å±±ç¼–å·;ksbh,çŸ¿å±±ä½ç½®;kswz,ç°è®¸å¯è¯å·;xxkz,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid_tddj",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid_tddj').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid_tddj').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
         // {
         //   xtype: 'combo',
         //   name: 'aj_select',
         //   store: aj_where_field_data,
         //   emptyText:'æ¡ˆå·æ ‡é¢˜',
         //   mode: 'local',
         //   minChars : 2,
         //   valueField:'text',
         //   displayField:'text',
         //   triggerAction:'all',
         //   id:'aj_select_field'
         // } ,
         //   '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
         // {
         //   xtype:'textfield',
         //   id:'query_text'                        } ,         
         // { 
         //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
         //   handler: function() {
         //     console.log(Ext.getCmp('query_text').value);
         //     if(Ext.getCmp('query_text').value != null ){
         //       var grid = Ext.getCmp('archive_grid_tddj');
         //       grid.store.proxy.url="/desktop/get_archive_where";
         //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
         //       archive_store.load();
         //     }
         //   }
        //  }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'æ¡ˆå·å·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'çŸ¿å±±åç§°',  width : 175, sortable : true, dataIndex: 'ksmc'},
          
          { text : 'çŸ¿ä¸šæƒäºº',  width : 175, sortable : true, dataIndex: 'kyqr'},
          { text : 'çŸ¿å±±ä½ç½®',  width : 175, sortable : true, dataIndex: 'kswz'},
          { text : 'çŸ¿å±±ç¼–å·',  width : 175, sortable : true, dataIndex: 'ksbh'},
          { text : 'çŸ¿ç§',  width : 175, sortable : true, dataIndex: 'kz'},
          { text : 'çŸ¿åŒºèŒƒå›´',  width : 75, sortable : true, dataIndex: 'kqfw'},
          
          { text : 'ä»¶æ•°',  width : 75, sortable : true, dataIndex: 'js'},
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          //{ text : 'èµ·æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'qrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          //{ text : 'æ­¢æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'zrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'èµ·å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qny'},
          { text : 'æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'zny'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_kyq(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
        set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab); 
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    
    var AjListFn_wsda = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid_wsda');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                if(id=="yes"){
                  new Ajax.Request("/desktop/delete_document", { 
                    method: "POST",
                    parameters: {id:record.data.id,userid:currentUser.id},
                    onComplete:  function(request) {
                      Ext.getCmp('document_grid').store.load();

                    }
                  });
                }                  
              });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } , '->',
                '<span style=" font-size:12px;font-weight:600;color:#3366FF;">é¢˜åæŸ¥è¯¢</span>:&nbsp;&nbsp;',
                {
                  xtype:'textfield',id:'query_jr_text'
                },          
                {xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢å·å†…ç›®å½•',iconCls:'accordion',
                    handler: function() {
                      store3.proxy.url="/desktop/get_document_where";
                      store3.proxy.extraParams.query=Ext.getCmp('query_jr_text').value;
                      store3.load();
                    }
                }
          
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },

        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'jgwth',   type: 'string'},
          {name: 'gbjh',    type: 'string'},
          {name: 'xbbm',    type: 'string'},
          {name: 'jh',    type: 'string'},
          {name: 'zwrq',    type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'wh',    type: 'string'},
          {name: 'zrr',   type: 'string'},
          {name: 'gb',    type: 'string'},
          {name: 'wz',    type: 'string'},
          {name: 'ztgg',    type: 'string'},
          {name: 'ztlx',    type: 'string'},
          {name: 'ztdw',    type: 'string'},
          {name: 'dagdh',   type: 'string'},
          {name: 'swh',   type: 'string'},
          {name: 'ztsl',    type: 'integer'},
          {name: 'qwbs',    type: 'string'},
          {name: 'ztc',   type: 'string'},
          {name: 'zbbm',    type: 'string'},
          {name: 'hh',    type: 'string'},
          {name: 'dzwdh',   type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid_wsda',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
            {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
              handler: function() {

                var grid = Ext.getCmp('archive_grid_wsda');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_wsda(record,true,title);
              }
            } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid_wsda');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid_wsda').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });

              }
            },
            {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid_wsda');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_wsda(record,false,title);
              }
            }   , 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("å¹´åº¦;docnd,ä¿ç®¡æœŸé™;bgqx,æœºæ„é—®é¢˜å·;jgwth,ä»¶å·;jh,é¢˜å;doctm,æ–‡å·;docwh,è´£ä»»è€…;doczrz,å¤‡æ³¨;bz","archive_grid_wsda",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid_wsda').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid_wsda').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
              //  '->',
              //  {
              //    xtype: 'combo',
              //    name: 'aj_select',
              //    store: aj_where_field_data,
              //    emptyText:'æ¡ˆå·æ ‡é¢˜',
              //    mode: 'local',
              //    minChars : 2,
              //    valueField:'text',
              //    displayField:'text',
              //    triggerAction:'all',
              //    id:'aj_select_field'
              //  } ,
              //  '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
              //  {
              //    xtype:'textfield',
              //    id:'query_text',
              //  } ,         
              //  { xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
              //    handler: function() {
              //      console.log(Ext.getCmp('query_text').value);
              //      if(Ext.getCmp('query_text').value != null ){
              //        var grid = Ext.getCmp('archive_grid_wsda');
              //        grid.store.proxy.url="/desktop/get_archive_where";
              //        archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
              //        archive_store.load();
              //      }
              //    }
              //  }
              ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'æœºæ„é—®é¢˜å·',  width : 75, sortable : true, dataIndex: 'jgwth'},
          { text : 'ä¿ç®¡æœŸé™', width : 75, sortable : true, dataIndex: 'bgqx'},
      
          { text : 'ä»¶å·',   width : 75, sortable : true, dataIndex: 'jh'},
          { text : 'æ–‡å·',   width : 75, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 175, sortable : true, dataIndex: 'zrr'},
          
          
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'åˆ¶æ–‡æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'zwrq' ,renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'ç¼©å¾®å·',  width : 75, sortable : true, dataIndex: 'swh'},
          
          
          { text : 'å…¨å®—å·', width : 0, sortable : true, dataIndex: 'qzh'},
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");

                switch (r.data.dalb) { 
                  case "0": 
                    DispAj_zh(r,false,title);
                    break; 
                  case "2": 
                    DispAj_cw(r,false,title);
                    break; 
                  case "3": 
                    DispAj_tddj(r,false,title);
                    break; 
                  case "24": 
                    DispAj_wsda(r,false,title);
                    break;
                  default:
                    DispAj_zh(r,false,title);
                    break;
                }

              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id;
    store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
        set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };

    var AjListFn_sx = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();

                        }
                      });
                    }
                });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'zl',    type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
        {
          xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
          handler: function() {

            var grid = Ext.getCmp('archive_grid');
            var records = grid.getSelectionModel().getSelection();
            var record = records[0];
            DispAj_sx(record,true,title);
          }
        },{
          xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
          handler: function() {

            var grid = Ext.getCmp('archive_grid');
            var records = grid.getSelectionModel().getSelection();
            var record = records[0];
            var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
            Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                  if(id=="yes"){
                    new Ajax.Request("/desktop/delete_archive", { 
                      method: "POST",
                      parameters: eval(pars),
                      onComplete:  function(request) {
                        if (request.responseText=='success'){
                            Ext.getCmp('archive_grid').store.load();
                        }else{
                            alert(request.responseText);
                        }
                      }
                    });
                  }
              });
            
            }
        },
        {
          xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
          handler: function() {
            var grid = Ext.getCmp('archive_grid');
            var records = grid.getSelectionModel().getSelection();
            var record = records[0];
            DispAj_sx(record,false,title);
          }
        } , 
        {
          xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
          handler: function() {
            showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
          }
        }, 
        {
          text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
          iconCls:'',
          handler : function() {
            var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
            if (items.length > 0) {
              var item = items[0];
              var dh = items[0].data.dh;
              show_image(dh);                 
              set_image("/assets/dady/fm.jpg");
            }
          }    
        },
    {
          text:'å¤‡è€ƒè¡¨',
          iconCls:'yl',
          handler : function() {
            var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
            if (items.length > 0) {
              var item = items[0];
              var id = items[0].data.id;
              DispBkb(id);
            }
          }    
        },
        '->',
       // {
       //   xtype: 'combo',
       //   name: 'aj_select',
       //   store: aj_where_field_data,
       //   emptyText:'æ¡ˆå·æ ‡é¢˜',
       //   mode: 'local',
       //   minChars : 2,
       //   valueField:'text',
       //   displayField:'text',
       //   triggerAction:'all',
       //   id:'aj_select_field'
       // } ,
       // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
       // {
       //   xtype:'textfield',
       //   id:'query_text' 
       // },         
       // { 
       //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
       //   handler: function() {
       //     console.log(Ext.getCmp('query_text').value);
       //     if(Ext.getCmp('query_text').value != null ){
       //       var grid = Ext.getCmp('archive_grid');
       //       grid.store.proxy.url="/desktop/get_archive_where";
       //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
       //       archive_store.load();
       //     }
       //   }
       // }
        ],

        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'æ¡ˆå·å·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'æ ‡é¢˜åç§°',  width : 175, sortable : true, dataIndex: 'tm'},
          
          
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'ä»¶æ•°',  width : 75, sortable : true, dataIndex: 'js'},
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          { text : 'èµ·æ—¥æœŸ',  width : 0, sortable : true, dataIndex: 'qrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'æ­¢æ—¥æœŸ',  width : 0, sortable : true, dataIndex: 'zrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'èµ·å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qny'},
          { text : 'æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'zny'},
          { text : 'ç§ç±»',   width : 75, sortable : true, dataIndex: 'zl'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                switch (r.data.dalb) { 
                  case "0": 
                    DispAj_zh(r,false,title);
                    break; 
                  case "15": 
                    DispAj_sx(r,false,title);
                    break;
                  case "2": 
                    DispAj_cw(r,false,title);
                    break; 
                  case "3": 
                    DispAj_tddj(r,false,title);
                    break; 
                  default:
                    DispAj_zh(r,false,title);
                    break;
                }
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
        set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: [documentGrid]
          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    
    var AjListFn_tjml = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      		{name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();

                        }
                      });
                    }
                });
              
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
              var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                  }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
             }
          
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      	  { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      	  { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'tfh',   type: 'string'},
          {name: 'tgh',   type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }

      });

      archive_store.load();
      
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        
        tbar:[{
              xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_tjml(record,true,title);
              }
            },{
                xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
                handler: function() {

                  var grid = Ext.getCmp('archive_grid');
                  var records = grid.getSelectionModel().getSelection();
                  var record = records[0];

                  var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });
                }
              },
              {
                xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
                handler: function() {
                  var grid = Ext.getCmp('archive_grid');
                  var records = grid.getSelectionModel().getSelection();
                  var record = records[0];
                  DispAj_tjml(record,false,title);
                }
              }, 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      		{
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
                  '->',
                //  {
                //    xtype: 'combo',
                //    name: 'aj_select',
                //    store: aj_where_field_data,
                //    emptyText:'æ¡ˆå·æ ‡é¢˜',
                //    mode: 'local',
                //    minChars : 2,
                //    valueField:'text',
                //    displayField:'text',
                //    triggerAction:'all',
                //    id:'aj_select_field'
                //  },
                //  '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
                //  {
                //    xtype:'textfield',
                //    id:'query_text'
                //  },         
                //  { 
                //    xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
                //    handler: function() {
                //      console.log(Ext.getCmp('query_text').value);
                //      if(Ext.getCmp('query_text').value != null ){
                //        var grid = Ext.getCmp('archive_grid');
                //        grid.store.proxy.url="/desktop/get_archive_where";
                //        archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
                //        archive_store.load();
                //      }
                //    }
                //  }
          ],
        columns: [
          { text : 'id',    width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',    width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·',   width : 75, sortable : true, dataIndex: 'mlh'},
      	  { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'åºå·',   width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'å›¾å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'å›¾å¹…å·', width : 75, sortable : true, dataIndex: 'tfh'},
          { text : 'å›¾æŸœå·', width : 75, sortable : true, dataIndex: 'tgh'},
          { text : 'å¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'å¼ æ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_tjml(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
      });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
	  });

      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',

        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: [documentGrid]
          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    
    var AjListFn_qtda_dzda = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {
              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
              
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'rjhj',    type: 'string'},
          {name: 'tgh',   type: 'string'},
          {name: 'czt',   type: 'string'},
          {name: 'sl',    type: 'string'},
          {name: 'bfs',   type: 'string'},
          {name: 'ztbhdwjgs', type: 'string'},
          {name: 'yyrjpt',  type: 'string'},
          {name: 'tjdw',    type: 'string'},
          {name: 'wjzt',    type: 'string'},
          {name: 'tjr',   type: 'string'},
          {name: 'czxt',    type: 'string'},
          {name: 'dzwjm',   type: 'string'},
          {name: 'ztbh',    type: 'string'},
          {name: 'xcbm',    type: 'string'},
          {name: 'xcrq',    type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'jsr',   type: 'string'},
          {name: 'jsdw',    type: 'string'},
          {name: 'yjhj',    type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_qtda_dzda(record,true,title);
            }
          } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });
              }
            },
            {
              xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_qtda_dzda(record,false,title);
              }
            }, 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // },         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'dh',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'æ¡£å·', width : 75, sortable : true, dataIndex: 'mlh'},
          { text : 'åˆ†ç±»å·', width : 75, sortable : true, dataIndex: 'flh'},         
          { text : 'é¡ºåºå·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'ç”µå­æ–‡ä»¶å', width : 75, sortable : true, dataIndex: 'dzwjm'},
          { text : 'å½¢æˆéƒ¨é—¨',  width : 75, sortable : true, dataIndex: 'xcbm'},
          
          { text : 'å½¢æˆæ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'xcrq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_qtda_dzda(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id;
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    var AjListFn_qtda_sbda = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {
             var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'dj',    type: 'string'},
          {name: 'je',    type: 'string'},
          {name: 'zcbh',    type: 'string'},
          {name: 'sybgr',   type: 'string'},
          {name: 'sybgdw',  type: 'string'},
          {name: 'cfdd',    type: 'string'},
          {name: 'sl',    type: 'integer'},
          {name: 'dw',    type: 'string'},
          {name: 'zcmc',    type: 'string'},
          {name: 'gzsj',    type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_qtda_sbda(record,true,title);
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
            Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                  if(id=="yes"){
                    new Ajax.Request("/desktop/delete_archive", { 
                      method: "POST",
                      parameters: eval(pars),
                      onComplete:  function(request) {
                        if (request.responseText=='success'){
                            Ext.getCmp('archive_grid').store.load();
                        }else{
                            alert(request.responseText);
                        }
                      }
                    });
                  }
              });
              }
            },
            {
              xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_qtda_sbda(record,false,title);
              }
            }, 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // } ,         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'ä»¶å·',   width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'èµ„äº§ç¼–å·',  width : 75, sortable : true, dataIndex: 'zcbh'},
          { text : 'èµ„äº§åç§°',  width : 75, sortable : true, dataIndex: 'zcmc'},
          { text : 'ä½¿ç”¨ä¿ç®¡å•ä½',  width : 175, sortable : true, dataIndex: 'sybgdw'},
          
          
          { text : 'ä½¿ç”¨ä¿ç®¡äºº', width : 75, sortable : true, dataIndex: 'sybgr'},
          
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          { text : 'è´­ç½®æ—¶é—´',   width : 75, sortable : true, dataIndex: 'gzsj', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'é‡‘é¢',   width : 75, sortable : true, dataIndex: 'je'},
          
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_qtda_sbda(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });

      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
 
    var AjListFn_qtda_jjda = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {
              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
              var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
          
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'xmmc',    type: 'string'},
          {name: 'jsdw',    type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });
      archive_store.load();
      
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_qtda_jjda(record,true,title);
            }
          } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });

              }
            },
            {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_qtda_jjda(record,false,title);
              }
            } , 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
            //{
            //  xtype: 'combo',
            //  name: 'aj_select',
            //  store: aj_where_field_data,
            //  emptyText:'æ¡ˆå·æ ‡é¢˜',
            //  mode: 'local',
            //  minChars : 2,
            //  valueField:'text',
            //  displayField:'text',
            //  triggerAction:'all',
            //  id:'aj_select_field'
            //} ,
            //  '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
            //{
            //  xtype:'textfield',
            //  id:'query_text'
            //} ,         
            //{ 
            //  xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
            //  handler: function() {
            //    console.log(Ext.getCmp('query_text').value);
            //    if(Ext.getCmp('query_text').value != null ){
            //      var grid = Ext.getCmp('archive_grid');
            //      grid.store.proxy.url="/desktop/get_archive_where";
            //      archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
            //      archive_store.load();
            //    }
            //  }
            //}
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'æ¡ˆå·å·',  width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡¹ç›®åç§°',  width : 175, sortable : true, dataIndex: 'xmmc'},
          
          { text : 'å»ºè®¾å•ä½',  width : 75, sortable : true, dataIndex: 'jsdw'},
          { text : 'å»ºè®¾å¹´ä»£',  width : 75, sortable : true, dataIndex: 'nd'},
          
          { text : 'é¡µæ•°',  width : 75, sortable : true, dataIndex: 'ys'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          
          { text : 'èµ·å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qny'},
          { text : 'æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'zny'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_qtda_jjda(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      
    
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    var AjListFn_qtda_swda = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();

                        }
                      });
                    }
                });
              
            }},
          {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
          handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
              DispJr(r,false);
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'mc',    type: 'string'},
          {name: 'ztxs',    type: 'string'},
          
          {name: 'bh',    type: 'string'},
          {name: 'lb',    type: 'string'},
          {name: 'hjz',   type: 'string'},
          {name: 'sjsj',    type: 'date',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
          {name: 'sjdw',    type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_qtda_swda(record,true,title);
            }
          } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });

              }
            },
            {
              xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_qtda_swda(record,false,title);
              }
            }, 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           //   '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // } ,         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'ä»¶å·',   width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'åç§°',  width : 175, sortable : true, dataIndex: 'mc'},
          
          { text : 'ç¼–å·',  width : 75, sortable : true, dataIndex: 'bh'},
          { text : 'è·å¥–è€…', width : 75, sortable : true, dataIndex: 'hjz'},
          
          { text : 'æˆå¥–å•ä½',  width : 75, sortable : true, dataIndex: 'sjdw'},
          { text : 'è·å¥–æ—¶é—´',  width : 75, sortable : true, dataIndex: 'sjsj',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          
          
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_qtda_swda(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
   		store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      
    
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    var AjListFn_qtda_zlxx = function(title,text) {
      
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
          
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
              DispJr(r,false);
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'bh',    type: 'string'},
          {name: 'lb',    type: 'string'},
          {name: 'bzdm',    type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],

        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_qtda_zlxx(record,true,title);
            }
          } ,
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
            Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                  if(id=="yes"){
                    new Ajax.Request("/desktop/delete_archive", { 
                      method: "POST",
                      parameters: eval(pars),
                      onComplete:  function(request) {
                        if (request.responseText=='success'){
                            Ext.getCmp('archive_grid').store.load();
                        }else{
                            alert(request.responseText);
                        }
                      }
                    });
                  }
              });
            }
          },
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_qtda_zlxx(record,false,title);
            }
          }   , 
            {
            xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
            handler: function() {
              showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
            }
          }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
          '->',
         // {
         //   xtype: 'combo',
         //   name: 'aj_select',
         //   store: aj_where_field_data,
         //   emptyText:'æ¡ˆå·æ ‡é¢˜',
         //   mode: 'local',
         //   minChars : 2,
         //   valueField:'text',
         //   displayField:'text',
         //   triggerAction:'all',
         //   id:'aj_select_field'
         // } ,
         // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
         // {
         //   xtype:'textfield',
         //   id:'query_text'
         // } ,         
         // { 
         //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
         //   handler: function() {
         //     console.log(Ext.getCmp('query_text').value);
         //     if(Ext.getCmp('query_text').value != null ){
         //       var grid = Ext.getCmp('archive_grid');
         //       grid.store.proxy.url="/desktop/get_archive_where";
         //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
         //       archive_store.load();
         //     }
         //   }
         // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          { text : 'åˆ†ç±»å·',  width : 75, sortable : true, dataIndex: 'flh'},
          { text : 'ä»¶å·',   width : 75, sortable : true, dataIndex: 'ajh'},
          { text : 'æ ‡é¢˜',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'ç¼–å·',  width : 75, sortable : true, dataIndex: 'bh'},
          { text : 'å‡ºç‰ˆå¹´åº¦',  width : 75, sortable : true, dataIndex: 'nd'},
          { text : 'ç¼–åˆ¶å•ä½',  width : 75, sortable : true, dataIndex: 'bzdm'},
          { text : 'ç±»åˆ«',  width : 75, sortable : true, dataIndex: 'lb'},
          { text : 'ä¿ç®¡æœŸé™',  width : 75, sortable : true, dataIndex: 'bgqx'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_qtda_zlxx(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id;
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    
    var AjListFn_by_tszlhj = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                  if(id=="yes"){
                    new Ajax.Request("/desktop/delete_document", { 
                      method: "POST",
                      parameters: {id:record.data.id,userid:currentUser.id},
                      onComplete:  function(request) {
                        Ext.getCmp('document_grid').store.load();

                      }
                    });
                  }
              });
              
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'djh',   type: 'string'},
          {name: 'kq',    type: 'string'},
          {name: 'yfdm',    type: 'string'},
          {name: 'fs',    type: 'string'},
          {name: 'mc',    type: 'string'},
          {name: 'cbrq',    type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'dj',    type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_by_tszlhj(record,true,title);
            }
          } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });

              }
            },
            {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_by_tszlhj(record,false,title);
              }
            }, 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
			{
              text:'å¯¼å‡ºExcel',
              iconCls:'save',
              handler : function() {				
                new Ajax.Request("/desktop/print_byml", { 
				  method: "POST",
                  parameters: {query:title},
                  onComplete:  function(request) {
					fhz=request.responseText.split(":");
	                if (fhz[0]=='success'){
                    	window.open(fhz[1],'','height=500,width=800,top=150, left=100,scrollbars=yes,status=yes');
					}else{
						alert(request.responseText);
					}
                  }
                });
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           //   '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // } ,         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç™»è®°å·', width : 75, sortable : true, dataIndex: 'djh'},
          { text : 'åˆŠæœŸ',   width : 75, sortable : true, dataIndex: 'kq'},
          { text : 'åç§°',  width : 175, sortable : true, dataIndex: 'mc'},
          { text : 'é‚®å‘ä»£ç ',  width : 75, sortable : true, dataIndex: 'yfdm'},
          { text : 'å‡ºç‰ˆæ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'cbrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å•ä»·',  width : 75, sortable : true, dataIndex: 'dj'},
          { text : 'ä»½æ•°',  width : 75, sortable : true, dataIndex: 'fs'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_by_tszlhj(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
            

        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      
    
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    var AjListFn_by_jcszhb = function(title,text) {
      dh='';
      
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 75, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},
          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'zt',    type: 'string'},
          {name: 'qy',    type: 'string'},
          {name: 'tjsj',    type: 'string'},
          {name: 'sm',    type: 'string'},                    
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }

      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_by_jcszhb(record,true,title);
            }
          } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });

              }
            },
            {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_by_jcszhb(record,false,title);
              }
            }   , 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
                '->',
               // {
               //   xtype: 'combo',
               //   name: 'aj_select',
               //   store: aj_where_field_data,
               //   emptyText:'æ¡ˆå·æ ‡é¢˜',
               //   mode: 'local',
               //   minChars : 2,
               //   valueField:'text',
               //   displayField:'text',
               //   triggerAction:'all',
               //   id:'aj_select_field'
               // } ,
               // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
               // {
               //   xtype:'textfield',
               //   id:'query_text'
               // } ,         
               // { xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
               //   handler: function() {
               //     console.log(Ext.getCmp('query_text').value);
               //     if(Ext.getCmp('query_text').value != null ){
               //       var grid = Ext.getCmp('archive_grid');
               //       grid.store.proxy.url="/desktop/get_archive_where";
               //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
               //       archive_store.load();
               //     }
               //   }
               // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 75, sortable : true, dataIndex: 'dh'},
          { text : 'ä¸“é¢˜', width : 75, sortable : true, dataIndex: 'zt'},
          { text : 'å‰è¨€',   width : 75, sortable : true, dataIndex: 'qy'},
          { text : 'ç»Ÿè®¡æ•°æ®',  width : 175, sortable : true, dataIndex: 'tjsj'},
          { text : 'è¯´æ˜',  width : 75, sortable : true, dataIndex: 'sm'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_by_jcszhb(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    
    var AjListFn_by_zzjgyg = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
              
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {
              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispJr(r,false);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      });
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'jgmc',    type: 'string'},
          {name: 'zzzc',    type: 'string'},
          {name: 'qzny',    type: 'string'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });
      archive_store.load();

      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
        {
          xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
          handler: function() {
            var grid = Ext.getCmp('archive_grid');
            var records = grid.getSelectionModel().getSelection();
            var record = records[0];
            DispAj_by_zzjgyg(record,true,title);
          }
        },
        {
          xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
          handler: function() {

            var grid = Ext.getCmp('archive_grid');
            var records = grid.getSelectionModel().getSelection();
            var record = records[0];

            var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
            Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                  if(id=="yes"){
                    new Ajax.Request("/desktop/delete_archive", { 
                      method: "POST",
                      parameters: eval(pars),
                      onComplete:  function(request) {
                        if (request.responseText=='success'){
                            Ext.getCmp('archive_grid').store.load();
                        }else{
                            alert(request.responseText);
                        }
                      }
                    });
                  }
              });
            }
          },
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_by_zzjgyg(record,false,title);
            }
          },
            {
            xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
            handler: function() {
              showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
            }
          }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
        '->',
         // {
         //   xtype: 'combo',
         //   name: 'aj_select',
         //   store: aj_where_field_data,
         //   emptyText:'æ¡ˆå·æ ‡é¢˜',
         //   mode: 'local',
         //   minChars : 2,
         //   valueField:'text',
         //   displayField:'text',
         //   triggerAction:'all',
         //   id:'aj_select_field'
         // },
         //   '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
         // {
         //   xtype:'textfield',
         //   id:'query_text'
         // },         
         // { 
         //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
         //   handler: function() {
         //     console.log(Ext.getCmp('query_text').value);
         //     if(Ext.getCmp('query_text').value != null ){
         //       var grid = Ext.getCmp('archive_grid');
         //       grid.store.proxy.url="/desktop/get_archive_where";
         //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
         //       archive_store.load();
         //     }
         //   }
         // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'æœºæ„åç§°', width : 75, sortable : true, dataIndex: 'jgmc'},
          { text : 'ç»„ç»‡ç³»ç»Ÿé¢†å¯¼æˆå‘˜ç»„æˆ',   width : 175, sortable : true, dataIndex: 'zzzc'},
          { text : 'èµ·æ­¢å¹´æœˆ',  width : 75, sortable : true, dataIndex: 'qzny'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
          selType:'checkboxmodel',
          //multiSelect:true,
          listeners:{
            itemdblclick:{
              fn:function(v,r,i,n,e,b){
                var tt=r.get("zrq");
                DispAj_by_zzjgyg(r,false,title);
              }
            }
          },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });

      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   

      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };
    
    var AjListFn_by_dsj = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {

              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];

              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                    if(id=="yes"){
                      new Ajax.Request("/desktop/delete_document", { 
                        method: "POST",
                        parameters: {id:record.data.id,userid:currentUser.id},
                        onComplete:  function(request) {
                          Ext.getCmp('document_grid').store.load();
                        }
                      });
                    }
                });
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          } ,   {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
              DispJr(r,false);
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      });
      
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'dd',    type: 'string'},
          {name: 'jlr',   type: 'string'},
          {name: 'clly',    type: 'string'},
          {name: 'fsrq',    type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'jlrq',    type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'rw',    type: 'string'},
          {name: 'sy',    type: 'string'},
          {name: 'yg',    type: 'string'},              
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
          {xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_by_dsj(record,true,title);
            }
          } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });

              }
            },
            {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_by_dsj(record,false,title);
              }
            }   , 
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           // '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // } ,         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'åœ°ç‚¹', width : 75, sortable : true, dataIndex: 'dd'},
          { text : 'è®°å½•äºº',  width : 175, sortable : true, dataIndex: 'jlr'},
          { text : 'ææ–™æ¥æº',  width : 75, sortable : true, dataIndex: 'clly'},          
          { text : 'å‘ç”Ÿæ—¥æœŸ', width : 75, sortable : true, dataIndex: 'fsrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'è®°å½•æ—¥æœŸ',   width : 175, sortable : true, dataIndex: 'jlrq', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'äººç‰©',  width : 75, sortable : true, dataIndex: 'rw'},
          { text : 'äº‹ç”±',   width : 175, sortable : true, dataIndex: 'sy'},
          { text : 'å› æœ',  width : 75, sortable : true, dataIndex: 'yg'},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
        selType:'checkboxmodel',
        //multiSelect:true,
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
                DispAj_by_dsj(r,false,title);
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
        data = node.selected.items[0].data;
        timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
        timage_store.load();
      });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
          id:title,
          region: 'center',
          layout: 'fit',
          split:true,
          items: archiveGrid
        },{
          region: 'south',
          iconCls:'icon-grid',
          layout: 'fit',
          height: 150,
          split: true,
          collapsible: true,
          title: 'å·å†…ç›®å½•',
          items: documentGrid
        }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };

    var AjListFn_by_qzsm = function(title,text) {
      dh='';
      Ext.regModel('document_model', {
        fields: [
            {name: 'id',    type: 'integer'},
            {name: 'tm',    type: 'string'},
            {name: 'sxh',   type: 'string'},
      {name: 'mlh',    type: 'string'},
            {name: 'ajh',   type: 'string'},
            {name: 'yh',    type: 'string'},
            {name: 'wh',    type: 'string'},
            {name: 'zrz',   type: 'string'},
            {name: 'rq',    type: 'string',  type: 'date',  dateFormat: 'Y-m-d H:i:s'},
            {name: 'bz',    type: 'string'},
            {name: 'dh',    type: 'string'},
            {name: 'ownerid',   type: 'integer'}
        ]
      });
      
      var store3 = Ext.create('Ext.data.Store', {
        model : 'document_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_document',
          extraParams: {query:""},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      var documentGrid = new Ext.grid.GridPanel({
        id : 'document_grid',
        store: store3,
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ å·å†…ç›®å½•',iconCls:'add',
            handler: function() {
              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispJr(record,true);
            }
          },
          {
            xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤å·å†…ç›®å½•',iconCls:'remove',
            handler: function() {
              var grid = Ext.getCmp('document_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              var pars="id="+record.data.id;
              Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+";é¡ºåºå·ä¸ºï¼š"+record.data.sxh+"å·å†…ç›®å½•ï¼Ÿ",function callback(id){
                  if(id=="yes"){
                    new Ajax.Request("/desktop/delete_document", { 
                      method: "POST",
                      parameters: {id:record.data.id,userid:currentUser.id},
                      onComplete:  function(request) {
                        Ext.getCmp('document_grid').store.load();

                      }
                    });
                  }                  
              });
            }},
          {
            xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹å·å†…ç›®å½•',iconCls:'option',
            handler: function() {
            var grid  = this.ownerCt.ownerCt;
              var store = grid.getStore(); 
              var records = grid.getSelectionModel().getSelection();
              var data = [];
              Ext.Array.each(records,function(model){
                data.push(Ext.JSON.encode(model.get('id')));
                DispJr(model,false);
              });
            }
          },    {
                xtype:'button',text:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',tooltip:'ä»¥æ¨¡æ¿æ–¹å¼å¢åŠ å·å†…ç›®å½•',iconCls:'add',
                  handler: function() {
                      var grid = Ext.getCmp('archive_grid');                    
                      var records = grid.getSelectionModel().getSelection();
                      size=Ext.getCmp('archive_grid').getSelectionModel().getSelection().size();
                      if (size==1){         
                        size=Ext.getCmp('document_grid').store.count();
                          if (size>0){                                    
                            alert("æ­¤æ¡ˆå·å·²ç»æœ‰å·å†…ç›®å½•ï¼Œä¸èƒ½ä»¥æ¨¡æ¿æ–¹å¼è¿›è¡Œå¢åŠ å·å†…ç›®å½•ã€‚");
                          }else{
                            var record = records[0];
                            DispJr_model(record.data.id,record.data.dh,false);
                          }
                      }else{
                        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¡ˆå·ç›®å½•ã€‚");
                      }
                    }
             }    , 
             {
                  xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
                  handler: function() {
                    showAdvancedSearch("æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm","document_grid",title,"",true);
                  }
               }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
      { text : 'ç›®å½•å·',  width : 40, sortable : true, dataIndex: 'mlh'},
      { text : 'æ¡ˆå·å·',  width : 40, sortable : true, dataIndex: 'ajh'},
          { text : 'é¡ºåºå·',  width : 30, sortable : true, dataIndex: 'sxh'},
          { text : 'æ–‡å·',  width : 105, sortable : true, dataIndex: 'wh'},
          { text : 'è´£ä»»è€…',  width : 75, sortable : true, dataIndex: 'zrz'},
          { text : 'é¢˜å',  width : 175, sortable : true, dataIndex: 'tm'},
          { text : 'é¡µå·',  width : 75, sortable : true, dataIndex: 'yh'},

          { text : 'æ—¥æœŸ',  width : 75, sortable : true, dataIndex: 'rq',renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å¤‡æ³¨',  width : 75, sortable : true, dataIndex: 'bz'},
          { text : 'ownerid',  flex : 1, sortable : true, dataIndex: 'ownerid'}
          ],
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
              DispJr(r,false);
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      });
      
      Ext.regModel('archive_model', {
        fields: [
          {name: 'id',    type: 'integer'},
          {name: 'dwdm',    type: 'string'},
          {name: 'dh',    type: 'string'},
          {name: 'qzh',   type: 'string'},
          {name: 'mlh',   type: 'string'},
          {name: 'ajh',   type: 'string'},
          {name: 'tm',    type: 'string'},
          {name: 'flh',   type: 'string'},
          {name: 'nd',    type: 'string'},
          {name: 'qrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'zrq',   type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'js',    type: 'string'},
          {name: 'ys',    type: 'string'},
          {name: 'bgqx',    type: 'string'},
          {name: 'mj',    type: 'string'},
          {name: 'xh',    type: 'string'},
          {name: 'cfwz',    type: 'string'},
          {name: 'bz',    type: 'string'},
          {name: 'boxstr',  type: 'string'},
          {name: 'boxrfid', type: 'string'},
          {name: 'rfidstr', type: 'string'},
          {name: 'qny',   type: 'string'},
          {name: 'zny',   type: 'string'},
          {name: 'qzgczjj', type: 'string'},
          {name: 'sj',    type: 'date', dateFormat: 'Y-m-d H:i:s'},
          {name: 'dalb',    type: 'string'}
        ]
      });
      
      var archive_store = Ext.create('Ext.data.Store', {
        id:'archive_store',
        model : 'archive_model',
        proxy: {
          type: 'ajax',
          url : '/desktop/get_archive_qxdm',
          extraParams: {query:title},
          reader: {
            type: 'json',
            root: 'rows',
            totalProperty: 'results'
          }
        }
      });

      archive_store.load();
      var archiveGrid = new Ext.grid.GridPanel({
        id : 'archive_grid',
        store: archive_store,
        
        bbar:[
          new Ext.PagingToolbar({
            store: archive_store,
            pageSize: 25,
            width : 400,
            border : false,
            displayInfo: true,
            displayMsg: '{0} - {1} of {2}',
            emptyMsg: "æ²¡æœ‰æ‰¾åˆ°ï¼",
            prependButtons: true
          })
        ],
        tbar:[
          {
            xtype:'button',text:'æ·»åŠ ',tooltip:'æ·»åŠ æ¡ˆå·ä¿¡æ¯',id:'add',iconCls:'add',
            handler: function() {

              var grid = Ext.getCmp('archive_grid');
              var records = grid.getSelectionModel().getSelection();
              var record = records[0];
              DispAj_by_qzsm(record,true,title);
            }
          } ,
            {xtype:'button',text:'åˆ é™¤',tooltip:'åˆ é™¤æ¡ˆå·ä¿¡æ¯',id:'delete',iconCls:'remove',
              handler: function() {

                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];

                var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
                Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤æ¡£å·ä¸ºï¼šï¼"+record.data.dh+"çš„æ¡ˆå·ï¼Ÿ",function callback(id){
                      if(id=="yes"){
                        new Ajax.Request("/desktop/delete_archive", { 
                          method: "POST",
                          parameters: eval(pars),
                          onComplete:  function(request) {
                            if (request.responseText=='success'){
                                Ext.getCmp('archive_grid').store.load();
                            }else{
                                alert(request.responseText);
                            }
                          }
                        });
                      }
                  });

              }
            },
            {xtype:'button',text:'ä¿®æ”¹',tooltip:'æ˜¾ç¤ºæˆ–ä¿®æ”¹æ¡ˆå·ä¿¡æ¯',id:'save',iconCls:'option',
              handler: function() {
                var grid = Ext.getCmp('archive_grid');
                var records = grid.getSelectionModel().getSelection();
                var record = records[0];
                DispAj_by_qzsm(record,false,title);
              }
            },
            {
              xtype:'button',text:'é«˜çº§æŸ¥è¯¢',tooltip:'',id:'advance-search',iconCls:'search',
              handler: function() {
                showAdvancedSearch("ç›®å½•å·;mlh,æ¡ˆå·å·;ajh,å¹´åº¦;nd,ä¿ç®¡æœŸé™;bgqx,æ¡ˆå·æ ‡é¢˜;ajtm,æ–‡å·;wh,è´£ä»»è€…;zrz,å·å†…é¢˜å;tm,å¤‡æ³¨;bz","archive_grid",title);
              }
            }, 
            {
              text:'æŸ¥çœ‹å›¾åƒæˆ–é™„ä»¶',
              iconCls:'',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var dh = items[0].data.dh;
                  show_image(dh);                 
                  set_image("/assets/dady/fm.jpg");
                }
              }    
            },
      {
              text:'å¤‡è€ƒè¡¨',
              iconCls:'yl',
              handler : function() {
                var items = Ext.getCmp('archive_grid').getSelectionModel().selected.items;
                if (items.length > 0) {
                  var item = items[0];
                  var id = items[0].data.id;
                  DispBkb(id);
                }
              }    
            },
            '->',
           // {
           //   xtype: 'combo',
           //   name: 'aj_select',
           //   store: aj_where_field_data,
           //   emptyText:'æ¡ˆå·æ ‡é¢˜',
           //   mode: 'local',
           //   minChars : 2,
           //   valueField:'text',
           //   displayField:'text',
           //   triggerAction:'all',
           //   id:'aj_select_field'
           // } ,
           //   '&nbsp;&nbsp;<span style=" font-size:12px;font-weight:600;color:#3366FF;">æŸ¥è¯¢</span>:&nbsp;&nbsp;',
           // {
           //   xtype:'textfield',
           //   id:'query_text'
           // },         
           // { 
           //   xtype:'button',text:'æŸ¥è¯¢',tooltip:'æŸ¥è¯¢æ¡ˆå·ä¿¡æ¯',id:'query',iconCls:'search',
           //   handler: function() {
           //     console.log(Ext.getCmp('query_text').value);
           //     if(Ext.getCmp('query_text').value != null ){
           //       var grid = Ext.getCmp('archive_grid');
           //       grid.store.proxy.url="/desktop/get_archive_where";
           //       archive_store.proxy.extraParams.query=Ext.getCmp('query_text').value;
           //       archive_store.load();
           //     }
           //   }
           // }
        ],
        columns: [
          { text : 'id',  width : 0, sortable : true, dataIndex: 'id'},
          { text : 'dalb',  width : 0, sortable : true, dataIndex: 'dalb'},
          { text : 'æ¡£å·',  width : 0, sortable : true, dataIndex: 'dh'},
          { text : 'ç›®å½•å·', width : 75, sortable : true, dataIndex: 'mlh'},
          { text : 'å…¨å®—æ„æˆè€…ç®€ä»‹',  width : 175, sortable : true, dataIndex: 'qzgczjj'},
          { text : 'æ—¶é—´',  width : 75, sortable : true, dataIndex: 'sj', renderer: Ext.util.Format.dateRenderer('Y-m-d')},
          { text : 'å•ä½ä»£ç ',  width : 75, sortable : true, dataIndex: 'dwdm'},
          { text : 'å¤‡æ³¨',  flex : 1, sortable : true, dataIndex: 'bz'}
          ],
        selType:'checkboxmodel',
        //multiSelect:true,
        listeners:{
          itemdblclick:{
            fn:function(v,r,i,n,e,b){
              var tt=r.get("zrq");
              DispAj_by_qzsm(r,false,title);
            }
          }
        },
        viewConfig: {
          stripeRows:true
        }
      }); 
        
      documentGrid.on("select", function(node){
          data = node.selected.items[0].data;
          timage_store.proxy.extraParams = {dh:data.dh, type:'1'};
          timage_store.load();
        });
        
      archiveGrid.on("select",function(node){
        data = node.selected.items[0].data;    // data.id, data.parent, data.text, data.leaf
        archive_id = data.id; 
    	store3.proxy.url="/desktop/get_document";
        store3.proxy.extraParams.query=data.id;
        store3.load();
        dh=data.dh;
        new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
	        method: "POST",
	        parameters: eval("({userid:" + currentUser.id + ",qxdm:'i',qxlb:1,dh:'" + dh + "'})"),
	        onComplete:  function(request) {
	          if (request.responseText=='success'){
        		timage_store.proxy.extraParams = {dh:data.dh, type:'0'};
        		timage_store.load();
        		Ext.getCmp('timage_combo').lastQuery = null;
			  }
			}
		})
      	set_imagearchive("/assets/dady/fm.jpg");
      });
      
    
      
      var tab = tabPanel.getActiveTab();
      tabPanel.remove(tab);   
      var tabPage = tabPanel.add({
        title:text,
        closable:true,
        iconCls:'tabs',
        layout: 'border',
        split:true,
        items:[{
            id:title,
            region: 'center',
            layout: 'fit',
            split:true,
            items: archiveGrid
          },{
            region: 'south',
            iconCls:'icon-grid',
            layout: 'fit',
            height: 150,
            split: true,
            collapsible: true,
            title: 'å·å†…ç›®å½•',
            items: documentGrid

          }]
      });
      tabPanel.setActiveTab(tabPage);
      userManagePageIsOpen = true;
    };

    
    
    var store1 = Ext.create('Ext.data.TreeStore', {
        autoLoad: true,
        proxy: {
            type: 'ajax',
            url: 'desktop/get_treeforuserid',
            extraParams: {node:"root",userid:currentUser.id
            },
            actionMethods: 'POST'
        }
    });
  
    var treePanel = Ext.create('Ext.tree.Panel', {
      store: store1,
      id:'archive_tree',
      rootVisible: false,
      useArrows: true,
      singleExpand: true,
      tbar:[
      {
        xtype:'button',text:'åˆ·æ–°ç›®å½•',tooltip:'åˆ·æ–°ç›®å½•',iconCls:'refresh',
        handler: function() {
          Ext.getCmp('archive_tree').store.load();
        }
      },'->',
   // {
     //   xtype:'button',text:'åˆ é™¤ç›®å½•',tooltip:'åˆ é™¤ç›®å½•',iconCls:'delete',
     //   handler: function() {
     //     //Ext.getCmp('archive_tree').store.load();
   //     var tree = Ext.getCmp('archive_tree');
     //     var records = tree.getSelectionModel().getSelection();
     //     var record = records[0];
   //     //data = node.selected.items[0].data;
   //     ss=record.data.id.split('_');
   //     if (ss.length=3 && ss[1]!=24){
     //         var pars="({id:'"+record.data.id+"',dalb:'"+record.data.dalb + "',userid:'" + currentUser.id +"'})";
   //         Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤ï¼š"+record.data.text+"çš„æ•´ä¸ªç›®å½•å·æ•°æ®ï¼Ÿ",function callback(id){
   //               if(id=="yes"){
   //                 new Ajax.Request("/desktop/delete_all_archive", { 
   //                   method: "POST",
   //                   parameters: eval(pars),
   //                   onComplete:  function(request) {
   //               if (request.responseText=='success'){
   //                         Ext.getCmp('archive_grid').store.load();
   //               }else{
   //                 alert(request.responseText);
   //               }
   //                   }
   //                 });
   //               }
   //          });
   //     }
   //     
     //   }
     // }
      ],
      width: 200
    });

    

    treePanel.on("select",function(node){ 
      data = node.selected.items[0].data;  // data.id, data.parent, data.text, data.leaf
      ss=data.id.split('_');
      if (ss.length>1){
        if (ss[1]<100){
            Ext.getCmp('timage_combo').lastQuery = null;
            set_imagearchive("/assets/dady/fm.jpg");
            switch (ss[1]) { 
              case "0": 
                AjListFn_zh(data.id,node.selected.items[0].parentNode.data.text+data.text);
                break; 
            case "15": 
              AjListFn_sx(data.id,node.selected.items[0].parentNode.data.text+data.text);
              break;
              case "2": 
                AjListFn_cw(data.id,node.selected.items[0].parentNode.data.text+data.text);
                break; 
              case "3": 
                      AjListFn_tddj(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break; 
            case "5": 
                      AjListFn_tddj(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "6": 
                      AjListFn_tddj(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "7": 
                      AjListFn_tddj(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "24":
              AjListFn_wsda(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "25":
              AjListFn_qtda_dzda(data.id,node.selected.items[0].parentNode.data.text+data.text);
              break;
            case "26":
              AjListFn_qtda_jjda(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "27":
              AjListFn_qtda_sbda(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;        
            case "28":
              AjListFn_qtda_swda(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "29":
              AjListFn_qtda_zlxx(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "30":
              AjListFn_by_tszlhj(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "31":
              AjListFn_by_jcszhb(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "32":
              AjListFn_by_zzjgyg(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "33":
              AjListFn_by_dsj(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "34":
              AjListFn_by_qzsm(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "18":
              AjListFn_tjml(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "20":
                  AjListFn_zp(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            case "35":
                  AjListFn_kyq(data.id,node.selected.items[0].parentNode.data.text+data.text);
                  break;
            default:
                AjListFn_zh(data.id,node.selected.items[0].parentNode.data.text+data.text);
                break;
            }
        }
      }
    });
  
    if(!win){
      win = desktop.createWindow({
        id: 'archiveman',
        title:'æ¡£æ¡ˆç®¡ç†â€”â€”å›½åœŸ',        
        width:1000,
        height:600,
        x:0,
        y:0,
        iconCls: 'archiveman',
        animCollapse:false,
        maximized:true,
        border: false,
        hideMode: 'offsets',
        layout: 'border',
        split:true,
        items: [
		  { 
            title:'æ¡£æ¡ˆç±»åˆ«',
            region:'west',
            iconCls:'dept_tree',
            xtype:'panel',
            margins:'5 2 5 5',
            width: 200,
            collapsible:true,//å¯ä»¥è¢«æŠ˜å 
            id:'west-tree',
            layout:'fit',
            split:true,
            items:treePanel
          },
          { 
			title:'æ¡£æ¡ˆæ•°æ®',
            iconCls:'icon-grid',
            region:'center',
            xtype:'panel',
            id:'center-grid',
            margins:'5 5 5 0',
            layout: 'fit',
            split:true,
            items:tabPanel,
            collapsible:true
          },
		  {
              title: 'å½±åƒå›¾åˆ—è¡¨',
              collapsible: true,
              iconCls:'dept_tree',
              region:'east',
              margins: '5 0 0 0',
              cmargins: '5 5 0 0',
              split:true,
              width: 300,
              minSize: 100,
              maxSize: 250,
        id:'imagelist',
              layout:'fit',
              tbar:myuploadform,
              bbar:[
			  {
                xtype: 'combo',
                x: 130,
                y: 190,
                width: 100,
                name: 'yxbh',
                id: 'timage_combo',
                store: timage_store,
                emptyText:'è¯·é€‰æ‹©',
                mode: 'local',
                minChars : 2,
                valueField:'id',
                displayField:'yxbh',
                triggerAction:'all',
                listeners:{
                  select:function(combo, record, index) {
                  var pars={gid:record[0].data.id, type:timage_store.proxy.extraParams.type,userid:currentUser.id};
                  new Ajax.Request("/desktop/get_timage_from_db", {
                    method: "POST",
                    parameters: pars,
                    onComplete:  function(request) {
                      path = request.responseText;
                      if (path != '') { 
                        set_imagearchive("/assets/dady/fm.jpg");
                        if (path.toUpperCase().include('JPG') || path.toUpperCase().include('TIF') || path.toUpperCase().include('JPEG') || path.toUpperCase().include('TIFF')) { 
                          ifx=path.split('?');
                          imagefx=ifx[1];
                          imageObj1.src = path;
                          drawarchive(scale, translatePos1,imageObj1);
                        }else{        
                          //location.href= path;
                          window.open(path,'','height=500,width=800,top=150, left=100,scrollbars=yes,status=yes');
                          imageObj1.src = '';
                          drawchive(scale, translatePos1,imageObj1);
                        }
                      }
                    }
                  });
                  }
                }
              },
              {
                text: 'ä¸Šä¸€ä¸ª',
                handler: function(){
                  combo = Ext.getCmp('timage_combo');
                  var currentImage = combo.getStore().getById(combo.getValue());
                  var currentStoreIndex = combo.getStore().indexOf(currentImage);
                  var nextStoreValue = combo.getStore().getAt(currentStoreIndex - 1).get('id');
                  combo.setValue(nextStoreValue);
                  var pars={gid:nextStoreValue, type:timage_store.proxy.extraParams.type,userid:currentUser.id};
          new Ajax.Request("/desktop/get_timage_from_db", {
              method: "POST",
              parameters: pars,
              onComplete:  function(request) {
                path = request.responseText;
                if (path != '') { 
            //set_image("/assets/dady/fm.jpg");
            set_imagearchive("/assets/dady/fm.jpg");
            if (path.toUpperCase().include('JPG') || path.toUpperCase().include('TIF') || path.toUpperCase().include('JPEG') || path.toUpperCase().include('TIFF')) { 
              ifx=path.split('?');
              imagefx=ifx[1];
                    imageObj1.src = path;
                    drawarchive(scale, translatePos1,imageObj1);
            }else{        
              //location.href= path;
              window.open(path,'','height=500,width=800,top=150, left=100,scrollbars=yes,status=yes');
              imageObj1.src = '';
                    drawchive(scale, translatePos1,imageObj1);
            }
                }
              }
            });


                
        }

              },
              {
                text: 'ä¸‹ä¸€ä¸ª',
                handler: function(){
                  combo = Ext.getCmp('timage_combo');
                  var currentImage = combo.getStore().getById(combo.getValue());
                  var currentStoreIndex = combo.getStore().indexOf(currentImage);
                  var nextStoreValue = combo.getStore().getAt(currentStoreIndex + 1).get('id');
                  combo.setValue(nextStoreValue);
                  var pars={gid:nextStoreValue, type:timage_store.proxy.extraParams.type,userid:currentUser.id};
                  new Ajax.Request("/desktop/get_timage_from_db", {
              method: "POST",
              parameters: pars,
              onComplete:  function(request) {
                path = request.responseText;
                if (path != '') { 
            //set_image("/assets/dady/fm.jpg");
            set_imagearchive("/assets/dady/fm.jpg");
            if (path.toUpperCase().include('JPG') || path.toUpperCase().include('TIF') || path.toUpperCase().include('JPEG') || path.toUpperCase().include('TIFF')) { 
              ifx=path.split('?');
              imagefx=ifx[1];
                    imageObj1.src = path;
                    drawarchive(scale, translatePos1,imageObj1);
            }else{        
              //location.href= path;
              window.open(path,'','height=500,width=800,top=150, left=100,scrollbars=yes,status=yes');
              imageObj1.src = '';
                    drawchive(scale, translatePos1,imageObj1);
            }
                }
              }
            });     

                }
              },
              {
                text: 'æ‰“å°å›¾åƒ',
                handler : function() {
          combo = Ext.getCmp('timage_combo').displayTplData[0].yxmc;
          if(combo!=''){
            new Ajax.Request("/desktop/get_users_sort_forqxdm", { 
                  method: "POST",
                  parameters: eval("({userid:" + currentUser.id + ",qxdm:'ip',qxlb:1,dh:'" + dh + "'})"),
                  onComplete:  function(request) {
                    if (request.responseText=='success'){
                            LODOP=getLodop(document.getElementById('LODOP'),document.getElementById('LODOP_EM'));                        
                            //LODOP.ADD_PRINT_BARCODE(0,0,200,100,"Code39","*123ABC4567890*");
                            //image_path = Ext.getCmp('preview_img').getEl().dom.src.replace(/-/ig, "_");
                            //image_path = Ext.getCmp('preview_img').getEl().dom.src;
                    image_path = window.location.href + "/assets/dady/img_tmp/" + dh + "/" + combo;
                            LODOP.PRINT_INIT(image_path);
                            LODOP.SET_PRINT_PAGESIZE(imagefx,0,0,"A4");
                            LODOP.ADD_PRINT_IMAGE(0,0,1000,1410,"<img border='0' src='"+image_path+"' width='100%' height='100%'/>");
                            LODOP.SET_PRINT_STYLEA(0,"Stretch",2);//(å¯å˜å½¢)æ‰©å±•ç¼©æ”¾æ¨¡å¼
                            LODOP.SET_PRINT_MODE("PRINT_PAGE_PERCENT","Full-Page");
                            LODOP.PREVIEW();
                            //LODOP.PRINT();
                }else{
                        alert('æ‚¨æ— æ­¤ç±»æ¡£æ¡ˆçš„æ‰“å°å½±åƒæ–‡ä»¶çš„æƒé™ã€‚');
                      }
                    }
            });
          }
                }
              },
              {
                  text: 'åˆ é™¤å›¾åƒ',
                  handler : function() {
                  if (dh!=''){
                    combo = Ext.getCmp('timage_combo').displayTplData[0].yxbh;
                    if (combo!=''){
                      Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦åˆ é™¤ï¼š"+combo+" å›¾åƒï¼Ÿ",function callback(id){
                        if(id=="yes"){
                          var pars="{yxmc:'"+combo+"',dh:'"+dh + "'}";                        
                          new Ajax.Request("/desktop/delete_timage", {
                              method: "POST",
                              //parameters: {yxmc:combo,dh:dh},
                              parameters: eval("({yxmc:'" + combo + "',dh:'" + dh +"',userid:" + currentUser.id + "})"),
                              onComplete:  function(request) {
                                var path = request.responseText;

                if (path == 'notsort'){
                  alert("æ‚¨æ— åˆ é™¤æ­¤ç±»æ¡£æ¡ˆå½±åƒæ–‡ä»¶çš„æƒé™ã€‚")
                }else{
                                  if (path == 'success') { 
                                    timage_store.proxy.extraParams = {dh:dh, type:'0'};
                                    timage_store.load();
                                    Ext.getCmp('timage_combo').lastQuery = null;
                                    //Ext.getCmp('preview_img').getEl().dom.src = '';
                    set_imagearchive("/assets/dady/fm.jpg");
                                  }
                }
                              }
                          });
                        }
                      });
                    }
                  }
                  }   // handler
              },
              {
                  text: 'åˆ é™¤æ•´å·å›¾åƒ',
                  handler : function() {
                  if (dh!=''){
          combo = Ext.getCmp('timage_combo').displayTplData[0].yxbh;
                      Ext.Msg.confirm("æç¤ºä¿¡æ¯","æ˜¯å¦è¦æ•´å·åˆ é™¤å›¾åƒï¼Ÿ",function callback(id){
                        if(id=="yes"){
                          var pars="{dh:'"+dh + "'}";
                          new Ajax.Request("/desktop/delete_all_timage", {
                              method: "POST",
                              //parameters: {dh:dh},
                              parameters: eval("({yxmc:'" + combo + "',dh:'" + dh +"',userid:" + currentUser.id + "})"),
                              onComplete:  function(request) {
                                var path = request.responseText;
                                if (path == 'notsort'){
                                    alert("æ‚¨æ— åˆ é™¤æ­¤ç±»æ¡£æ¡ˆå½±åƒæ–‡ä»¶çš„æƒé™ã€‚")
                                }else{
                                    if (path == 'success') { 
                                      timage_store.proxy.extraParams = {dh:dh, type:'0'};
                                      timage_store.load();
                                      Ext.getCmp('timage_combo').lastQuery = null;
                                      Ext.getCmp('preview_img').getEl().dom.src = '';
                                    }
                                }
                              }
                          });
                        }
                      });                    
                  }
                  }   // handler
              }],     //bbar

              items:[			   
				{
					xtype: 'panel', //æˆ–è€…xtype: 'component',
					layout:'fit',
		        	html:canvas_string
				}
        	  ]
		  }
		]

      });
    };
    
    
    new Ajax.Request("/desktop/get_sort", { 
        method: "POST",
        parameters: eval("({userid:" + currentUser.id + ",qxid:2})"),
        onComplete:  function(request) {
          if (request.responseText=='success'){
            win.show();
          }else{
            alert('æ‚¨æ— å›½åœŸæ¡£æ¡ˆç®¡ç†çš„æƒé™ã€‚');
            Ext.getCmp('archiveman').close();
          }
        }
    });
    return win;
  }
});

:@created_atf1382861565.875627 
F:@compressedF