Ext.define('MyDesktop.SystemStatus',{extend:'Ext.ux.desktop.Module',requires:['Ext.chart.*','Ext.tree.*','Ext.data.*','Ext.grid.*','Ext.ux.CheckColumn','Ext.window.MessageBox'],id:'systemstatus',init:function(){this.launcher={text:'档案统计',iconCls:'cpustats',handler:this.createWindow,scope:this}},createWindow:function(){var desktop=this.app.getDesktop();var win=desktop.getWindow('systemstatus');var scale=0.64;var scaleMultiplier=0.8;var translatePos={x:0,y:0};var imageObj=new Image();var draw=function(scale,translatePos,imageObj){var canvas=document.getElementById("myCanvas");var context=canvas.getContext("2d");context.clearRect(0,0,canvas.width,canvas.height);context.save();imageObj.onload=function(){imgW=imageObj.width;imgH=imageObj.height;context.drawImage(imageObj,translatePos.x,translatePos.y,imgW*scale,imgH*scale)};imgW=imageObj.width;imgH=imageObj.height;context.drawImage(imageObj,translatePos.x,translatePos.y,imgW*scale,imgH*scale);context.restore()};var draw_new=function(scale,translatePos,imageObj){var canvas=document.getElementById("myCanvas");var context=canvas.getContext("2d");context.clearRect(0,0,canvas.width,canvas.height);context.save();var imgW=imageObj.width;var imgH=imageObj.height;context.scale(scale,scale);imageObj.onload=function(){var centerX=translatePos.x+canvas.width/2;var centerY=translatePos.y+canvas.height/2;imgW=imageObj.width;imgH=imageObj.height;context.drawImage(imageObj,centerX-imgW*scale/2.0,centerY-imgH*scale/2.0,imgW*scale,imgH*scale)};var centerX=translatePos.x+canvas.width/2;var centerY=translatePos.y+canvas.height/2;imgW=imageObj.width;imgH=imageObj.height;context.drawImage(imageObj,centerX-imgW*scale/2.0,centerY-imgH*scale/2.0,imgW*scale,imgH*scale);context.restore()};var show_image=function(){var canvas_string='<div id="wrapper">'+' <canvas id="myCanvas" width="600" height="800">'+' </canvas>'+'</div>';var yxtree_store=Ext.create('Ext.data.TreeStore',{autoLoad:true,proxy:{type:'ajax',url:'desktop/get_yx_tree',extraParams:{node:"root",dh:""},actionMethods:'POST'}});var yxtreePanel=Ext.create('Ext.tree.Panel',{store:yxtree_store,id:'yx_show_tree',rootVisible:false,useArrows:true,singleExpand:true,autoScroll:true,width:200});yxtreePanel.on("select",function(node){data=node.selected.items[0].data;ss=data.id.split('|');var pars={gid:ss[0]};new Ajax.Request("/desktop/get_timage_from_db",{method:"POST",parameters:pars,onComplete:function(request){var path=request.responseText;if(path!=''){imageObj.src=path;draw(scale,translatePos,imageObj)}}})});var yxxs_win=new Ext.Window({id:'yxxs_win',iconCls:'picture16',title:'影像浏览',floating:true,shadow:true,draggable:true,closable:true,modal:true,width:800,height:600,layout:'fit',plain:true,items:[{layout:"border",items:[{region:"center",title:"图像",tbar:[{text:'放大',iconCls:'zoomin',handler:function(){scale/=scaleMultiplier;draw(scale,translatePos,imageObj)}},{text:'缩小',iconCls:'zoomout',handler:function(){scale*=scaleMultiplier;draw(scale,translatePos,imageObj)}},{text:'上一页',iconCls:'up16',handler:function(){var yxtree_panel=Ext.getCmp('yx_show_tree');var node=yxtree_panel.selModel.selected.items[0];var prev_node=node.previousSibling;yxtree_panel.selModel.select(prev_node);}},{text:'下一页',iconCls:'down16',handler:function(){var yxtree_panel=Ext.getCmp('yx_show_tree');var node=yxtree_panel.selModel.selected.items[0];var next_node=node.nextSibling;yxtree_panel.selModel.select(next_node)}}],items:[{xtype:'panel',html:canvas_string}]},{title:'影像列表',region:'west',iconCls:'wenshu16',xtype:'panel',width:200,collapsible:true,id:'yxtree-panel',layout:'fit',split:true,items:[yxtreePanel]}]}]});yxxs_win.show()};var set_image=function(photoURL){var canvas=document.getElementById("myCanvas");var context=canvas.getContext("2d");var startDragOffset={};var mouseDown=false;translatePos={x:0,y:0};imageObj.src=photoURL;canvas.addEventListener("mousedown",function(evt){mouseDown=true;startDragOffset.x=evt.clientX-translatePos.x;startDragOffset.y=evt.clientY-translatePos.y});canvas.addEventListener("mouseup",function(evt){mouseDown=false});canvas.addEventListener("mouseover",function(evt){mouseDown=false});canvas.addEventListener("mouseout",function(evt){mouseDown=false});canvas.addEventListener("mousemove",function(evt){if(mouseDown){translatePos.x=evt.clientX-startDragOffset.x;translatePos.y=evt.clientY-startDragOffset.y;draw(scale,translatePos,imageObj)}});draw(scale,translatePos,imageObj)};Ext.regModel('qzgl_model',{fields:[{name:'id',type:'integer'},{name:'qzh',type:'integer'},{name:'dalb',type:'integer'},{name:'mlh',type:'integer'},{name:'qajh',type:'integer'},{name:'zajh',type:'integer'},{name:'ajys',type:'integer'},{name:'jnts',type:'integer'},{name:'smyx',type:'integer'},{name:'ml00',type:'integer'},{name:'mlbk',type:'integer'},{name:'mljn',type:'integer'},{name:'jnjn',type:'integer'},{name:'jn00',type:'integer'},{name:'jnbk',type:'integer'},{name:'a4',type:'integer'},{name:'a3',type:'integer'},{name:'dt',type:'integer'},{name:'lijr',type:'string'},{name:'jmcr',type:'string'},{name:'dtxs',type:'string'},{name:'zt',type:'string'},{name:'json',type:'string'},{name:'dh_prefix',type:'string'},{name:'wcz',type:'integer'},{name:'mlm',type:'string'},{name:'yxwz',type:'string'}]});var qzgl_store=Ext.create('Ext.data.Store',{model:'qzgl_model',proxy:{type:'ajax',url:'/desktop/get_qzgl_store',extraParams:{qzh:"",filter:"",dalb:""},reader:{type:'json',root:'rows',totalProperty:'readerlts'}}});qzgl_store.proxy.extraParams={qzh:'10',filter:"全部",dalb:""};qzgl_store.load();var ztRender=function(val){if(val=="未入库"){return'<span style="color:red;">'+val+'</span>'}else if(val=="已归档"){return'<span style="color:blue;">'+val+'</span>'}else{return'<span style="color:gray;">'+val+'</span>'};return val};var qzgl_grid=new Ext.grid.GridPanel({title:'全宗管理',store:qzgl_store,id:'qzgl_grid_id',iconCls:'export',layout:'fit',columns:[{text:'id',align:"center",width:15,sortable:true,dataIndex:'id',hidden:true},{text:'全宗号',align:"left",width:50,sortable:true,dataIndex:'qzh'},{text:'档案类别',align:"left",width:50,sortable:true,dataIndex:'dalb'},{text:'目录号',align:"left",width:50,sortable:true,dataIndex:'mlh'},{text:'目录名',align:"left",width:50,sortable:true,dataIndex:'mlm'},{text:'始卷',align:"right",width:40,sortable:true,dataIndex:'qajh'},{text:'终卷',align:"right",width:40,sortable:true,dataIndex:'zajh'},{text:'总页数',align:"right",width:80,sortable:true,dataIndex:'ajys'},{text:'封面',align:"right",width:50,sortable:true,dataIndex:'ml00'},{text:'著录',align:"right",width:50,sortable:true,dataIndex:'mljn'},{text:'正文',align:"right",width:50,sortable:true,dataIndex:'smyx',tdCls:'x-change-cell'},{text:'备考',align:"right",width:50,sortable:true,dataIndex:'mlbk',},{text:'旧封',align:"right",width:50,sortable:true,dataIndex:'jn00'},{text:'旧卷',align:"right",width:50,sortable:true,dataIndex:'jnjn'},{text:'旧备',align:"right",width:50,sortable:true,dataIndex:'jnbk'},{text:'A4',align:"right",width:60,sortable:true,dataIndex:'a4',},{text:'A3',align:"right",width:60,sortable:true,dataIndex:'a3'},{text:'大图',align:"right",width:40,sortable:true,dataIndex:'dt'},{text:'目录数据',align:"left",width:150,sortable:true,dataIndex:'json'},{text:'文件路径',align:"left",width:100,sortable:true,dataIndex:'yxwz'},{text:'误差',align:"left",width:100,sortable:true,dataIndex:'wcz'},{text:'状态',align:"center",flex:1,sortable:true,dataIndex:'zt',renderer:ztRenderer}],selType:'checkboxmodel',multiSelect:true,viewConfig:{getRowClass:function(record,index){var c=record.get('smyx')-record.get('ajys');if(c<0){return'price-fall'}else if(c>0){return'price-rise'}else{return'price-zero'}}},tbar:['<span style=" font-size:12px;font-weight:600;color:#3366FF;">全宗号</span>:&nbsp;&nbsp;',{xtype:"textfield",id:'qzh_field',name:'qzh',width:40,value:'10',listeners:{'blur':function(field){qzgl_store.proxy.extraParams.qzh=field.getValue();qzgl_store.load()}}},{text:'打印统计',iconCls:'print',split:true,menu:{id:'dycl-slelect-menu',width:100,items:[{text:'打印汇总',iconCls:'print',handler:function(){items=Ext.getCmp('qzgl_grid_id').getSelectionModel().selected.items;id_str='';for(var i=0;i<items.length;i++){if(i==0){id_str=id_str+items[i].data.id}else{id_str=id_str+','+items[i].data.id}};pars={id:id_str};new Ajax.Request("/desktop/print_selected_qzxx",{method:"POST",parameters:pars,onComplete:function(request){qzzt_store.load()}})}},{text:'打印报表',iconCls:'print',handler:function(){items=Ext.getCmp('qzgl_grid_id').getSelectionModel().selected.items;id_str='';for(var i=0;i<items.length;i++){if(i==0){id_str=id_str+items[i].data.id}else{id_str=id_str+','+items[i].data.id}};pars={id:id_str};new Ajax.Request("/desktop/print_selected_qztj",{method:"POST",parameters:pars,onComplete:function(request){qzzt_store.load()}})}},'-',{text:'虚拟打印',iconCls:'print',handler:function(){items=Ext.getCmp('qzgl_grid_id').getSelectionModel().selected.items;id_str='';for(var i=0;i<items.length;i++){if(i==0){id_str=id_str+items[i].data.id}else{id_str=id_str+','+items[i].data.id}};pars={id:id_str};new Ajax.Request("/desktop/print_selected_mljn",{method:"POST",parameters:pars,onComplete:function(request){qzzt_store.load()}})}}]}},'-',{text:'挂接数据',iconCls:'import',handler:function(){Ext.regModel('sdwj_model',{fields:[{name:'id',type:'integer'},{name:'dh',type:'string'},{name:'mlh',type:'integer'},{name:'wjma',type:'string'},{name:'wjmb',type:'string'}]});var sdwj_store=Ext.create('Ext.data.Store',{model:'sdwj_model',proxy:{type:'ajax',url:'/desktop/get_sdwj_store',extraParams:{qzh:""},reader:{type:'json',root:'rows',totalProperty:'results'}}});sdwj_store.load();var sdwj_grid=new Ext.grid.GridPanel({title:'输档状态',store:sdwj_store,id:'sdwj_grid_id',iconCls:'task16',columns:[{text:'id',align:"center",width:15,sortable:true,dataIndex:'id',hidden:true},{text:'缩写',align:"left",width:50,sortable:true,dataIndex:'dh'},{text:'目录号',align:"left",width:50,sortable:true,dataIndex:'mlh'},{text:'案卷名',align:"left",width:250,sortable:true,dataIndex:'wjma'},{text:'卷内名',align:"left",width:250,sortable:true,dataIndex:'wjmb'}],selType:'checkboxmodel',multiSelect:true,viewConfig:{stripeRows:true},tbar:[{text:'删除选择',iconCls:'delete',handler:function(){items=Ext.getCmp('sdwj_grid_id').getSelectionModel().selected.items;id_str='';for(var i=0;i<items.length;i++){if(i==0){id_str=id_str+items[i].data.id}else{id_str=id_str+','+items[i].data.id}};pars={id:id_str};new Ajax.Request("/desktop/delete_sdwj",{method:"POST",parameters:pars,onComplete:function(request){sdwj_store.load()}})}},'-',{text:'导入JSON',iconCls:'import',handler:function(){items=Ext.getCmp('sdwj_grid_id').getSelectionModel().selected.items;id_str='';for(var i=0;i<items.length;i++){if(i==0){id_str=id_str+items[i].data.id}else{id_str=id_str+','+items[i].data.id}};pars={id:id_str};new Ajax.Request("/desktop/import_selected_aj",{method:"POST",parameters:pars,onComplete:function(request){Ext.getCmp('qzgl_tabpanel_id').setActiveTab(2);qzzt_store.load()}})}},'-',{text:'刷新',iconCls:'x-tbar-loading',handler:function(){sdwj_store.load()}}]});Ext.regModel('yxwz_model',{fields:[{name:'id',type:'integer'},{name:'dh',type:'string'},{name:'mlh',type:'integer'},{name:'mlm',type:'string'},{name:'yxwz',type:'string'}]});var yxwz_store=Ext.create('Ext.data.Store',{model:'yxwz_model',proxy:{type:'ajax',url:'/desktop/get_yxwz_store',extraParams:{qzh:""},reader:{type:'json',root:'rows',totalProperty:'results'}}});yxwz_store.load();var yxwz_grid=new Ext.grid.GridPanel({title:'影像位置',store:yxwz_store,id:'yxwz_grid_id',iconCls:'task16',columns:[{text:'id',align:"center",width:15,sortable:true,dataIndex:'id',hidden:true},{text:'档号',align:"left",width:50,sortable:true,dataIndex:'dh'},{text:'目录号',align:"left",width:50,sortable:true,dataIndex:'mlm'},{text:'影像位置',align:"left",width:250,sortable:true,dataIndex:'yxwz'}],selType:'checkboxmodel',multiSelect:true,viewConfig:{stripeRows:true},tbar:[{text:'删除选择',iconCls:'delete',handler:function(){items=Ext.getCmp('yxwz_grid_id').getSelectionModel().selected.items;id_str='';for(var i=0;i<items.length;i++){if(i==0){id_str=id_str+items[i].data.id}else{id_str=id_str+','+items[i].data.id}};pars={id:id_str};new Ajax.Request("/desktop/delete_yxwz",{method:"POST",parameters:pars,onComplete:function(request){sdwj_store.load()}})}},'-',{text:'导入影像',iconCls:'import',handler:function(){items=Ext.getCmp('yxwz_grid_id').getSelectionModel().selected.items;id_str='';for(var i=0;i<items.length;i++){if(i==0){id_str=id_str+items[i].data.id}else{id_str=id_str+','+items[i].data.id}};pars={id:id_str};new Ajax.Request("/desktop/import_selected_image",{method:"POST",parameters:pars,onComplete:function(request){Ext.getCmp('qzgl_tabpanel_id').setActiveTab(2);qzzt_store.load()}})}},'-',{text:'刷新',iconCls:'x-tbar-loading',handler:function(){yxwz_store.load()}}]});var qzsd_win=new Ext.Window({id:'qzsd_win',iconCls:'add',title:'数据设定',floating:true,shadow:true,draggable:true,closable:true,modal:false,width:640,height:500,layout:'absolute',plain:true,items:[{xtype:'label',text:'全宗号:',x:20,y:10},{xtype:'label',text:'全宗全名:',x:20,y:40},{xtype:'label',text:'全宗简称:',x:20,y:70},{xtype:'label',text:'全宗缩写:',x:20,y:100},{xtype:'label',text:'输档文件:',x:250,y:10},{xtype:'label',text:'影像位置:',x:250,y:40},{xtype:'label',text:'挂接位置:',x:250,y:70},{xtype:'textfield',x:80,y:10,name:'qzh',id:'qzh_id',listeners:{scope:this,'blur':function(field){if(field.getValue().length>0){var pars={qzh:field.getValue()};new Ajax.Request("/desktop/check_qzh",{method:"POST",parameters:pars,onComplete:function(request){var users=eval("("+request.responseText+")");if(users.size()>0){user=users[0];Ext.getCmp('dwdm_id').setValue(user.dwdm);Ext.getCmp('qzjc_id').setValue(user.dwjc);Ext.getCmp('qzsx_id').setValue(user.qzsx)}}})}}}},{xtype:'textfield',x:80,y:40,name:'dwdm',id:'dwdm_id'},{xtype:'textfield',x:80,y:70,name:'qzjc',id:'qzjc_id'},{xtype:'textfield',x:80,y:100,name:'qzsx',id:'qzsx_id'},{xtype:'form',id:'sdwj_upload_form',x:310,y:10,width:300,height:24,items:[{xtype:'fileuploadfield',anchor:'99%',name:'sdwj',emptyText:'选择一个文件...',buttonText:'浏览'},{xtype:'textfield',name:'dj',id:'sdwj_dj_id',hidden:true},{xtype:'textfield',name:'qzh',id:'sdwj_qzh_id',hidden:true}]},{xtype:'textfield',x:310,y:40,width:300,name:'yxwz',id:'yxwz_id',emptyText:'//192.168.114.50/jm1'},{xtype:'textfield',x:310,y:70,width:140,name:'gxwz',id:'gxwz_id',emptyText:'/mnt/lh/jm1'},{xtype:'textfield',x:470,y:70,width:140,name:'gxmm',id:'gxmm_id',emptyText:'hxgt1234'},{xtype:'button',text:'设置全宗',x:250,y:105,width:80,handler:function(){var qzh=Ext.getCmp('qzh_id').getValue();var dwdm=Ext.getCmp('dwdm_id').getValue();var dwjc=Ext.getCmp('qzjc_id').getValue();var qzsx=Ext.getCmp('qzsx_id').getValue();var pars={qzh:qzh,dwdm:dwdm,dwjc:dwjc,qzsx:qzsx};new Ajax.Request("/desktop/add_qzh2",{method:"POST",parameters:pars,onComplete:function(request){if(request.responseText=='Success'){msg('提示','全宗保存成功！')}}})}},{xtype:'button',text:'上传输档',x:340,y:105,width:80,handler:function(){myForm=Ext.getCmp('sdwj_upload_form').getForm();Ext.getCmp("sdwj_dj_id").setValue(Ext.getCmp('qzsx_id').getValue());Ext.getCmp("sdwj_qzh_id").setValue(Ext.getCmp('qzh_id').getValue());if(myForm.isValid()){form_action=1;myForm.submit({url:'/desktop/upload_sdwj',waitMsg:'文件上传中...',success:function(form,action){var isSuc=action.result.success;if(isSuc){msg('成功','文件上传成功.')}else{msg('失败','文件上传失败.')}},failure:function(){msg('失败','文件上传失败.')}})}}},{xtype:'button',text:'设定共享',x:430,y:105,width:80,handler:function(){var yxwz=Ext.getCmp('yxwz_id').getValue();var gxwz=Ext.getCmp('gxwz_id').getValue();var qzh=Ext.getCmp('qzh_id').getValue();var passwd=Ext.getCmp('gxmm_id').getValue();var pars={yxwz:yxwz,gxwz:gxwz,qzh:qzh,password:passwd};new Ajax.Request("/desktop/set_gxml",{method:"POST",parameters:pars,onComplete:function(request){if(request.responseText=='Success'){msg('提示','共享设定成功！')}}})}},{xtype:'button',text:'刷新目录',x:520,y:105,width:80},{xtype:'panel',x:5,y:140,height:420,